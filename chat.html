<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Agent - Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Söhne:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        /* =========================================================
           Stylesheet map
           - Theme + reset
           - Sidebar + controls
           - Main chat surface
           - Messages + markdown
           - Modals + explorer
           - Utilities + animations
           ========================================================= */
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #363636;
            --text-primary: #ececec;
            --text-secondary: #a0a0a0;
            --text-muted: #6b6b6b;
            --accent: #d97757;
            --accent-hover: #e8967a;
            --border: #3d3d3d;
            --user-msg: #2a4a5e;
            --assistant-msg: #1e1e1e;
            --success: #4ade80;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Söhne', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
        }

        .logo svg {
            width: 28px;
            height: 28px;
        }

        .api-key-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .api-key-section label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .api-key-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .api-key-input::placeholder {
            color: var(--text-muted);
        }

        .api-status {
            margin-top: 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .api-status.connected {
            color: var(--success);
        }

        .api-status.disconnected {
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .model-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .model-section > label:first-child {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .permission-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            line-height: 1.4;
        }

        .model-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .model-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .model-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        .model-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(217, 119, 87, 0.15);
            border-radius: 4px;
            font-size: 10px;
            color: var(--accent);
            margin-left: 8px;
            font-weight: 500;
        }

        .model-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .model-current {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .model-change-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .model-change-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .model-picker {
            position: relative;
        }

        .model-search-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-search-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        .model-search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .model-reset-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .model-reset-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .model-default-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.4;
        }

        .model-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 50;
            display: none;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        }

        .model-dropdown.open {
            display: block;
        }

        .model-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: var(--bg-hover);
        }

        .model-option.selected {
            background: rgba(217, 119, 87, 0.12);
            border-left: 2px solid var(--accent);
            padding-left: 10px;
        }

        .model-option-name {
            font-size: 13px;
            color: var(--text-primary);
        }

        .model-option-id {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
        }

        .model-option-empty {
            padding: 10px 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Skills section */
        .skills-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .skills-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .skills-header label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .add-skill-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-skill-btn:hover {
            background: rgba(217, 119, 87, 0.15);
        }

        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 420px;
            overflow-y: auto;
            padding: 4px;
        }

        .skill-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
        }

        .skill-item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .skill-item-name {
            color: var(--text-primary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .skill-item-desc {
            color: var(--text-muted);
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .skill-item-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .skill-item-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .skill-item-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .skill-item-btn.delete:hover {
            color: var(--error);
        }

        .no-skills {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: 12px;
        }

        .skills-drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            transition: all 0.2s;
            margin-top: 8px;
            background: var(--bg-tertiary);
            padding: 12px;
            min-height: 220px;
        }

        .skills-drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(217, 119, 87, 0.1);
        }

        .skills-drop-hint {
            display: none;
            text-align: center;
            padding: 16px 8px;
            color: var(--accent);
            font-size: 12px;
        }

        .skills-drop-zone.drag-over .skills-drop-hint {
            display: block;
        }

        .skills-drop-zone.drag-over .skills-list {
            display: none;
        }

        .skill-file-count {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        .skill-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .skills-pane {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .skills-pane-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .skills-pane-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .skills-pane-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .skills-pane-actions {
            display: flex;
            gap: 8px;
        }

        /* Upload zone in modal */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(217, 119, 87, 0.05);
        }

        .upload-zone.drag-over {
            border-color: var(--accent);
            background: rgba(217, 119, 87, 0.1);
        }

        .upload-zone-icon {
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .upload-zone-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .upload-zone-hint {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .upload-zone.has-file {
            border-color: var(--success);
            background: rgba(74, 222, 128, 0.1);
        }

        .upload-zone.has-file .upload-zone-icon {
            color: var(--success);
        }

        .or-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            color: var(--text-muted);
            font-size: 12px;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--accent);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .new-chat-btn {
            margin: 16px;
            padding: 12px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: var(--accent-hover);
        }

        .chats-section {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chats-section h3 {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
        }

        .chat-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.15s;
        }

        .chat-item:hover {
            background: var(--bg-hover);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
        }

        .chat-item-title {
            font-size: 14px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .chat-item-actions {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .chat-item {
            position: relative;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
            gap: 4px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .delete-btn:hover {
            color: var(--error);
            background: rgba(248, 113, 113, 0.1);
        }

        /* Main content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            min-width: 0;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .welcome h1 {
            font-size: 28px;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .welcome p {
            font-size: 16px;
            max-width: 500px;
            line-height: 1.6;
        }

        .messages {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.15s;
        }

        .copy-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .message.user .message-avatar {
            background: var(--user-msg);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--accent);
            color: white;
        }

        .message-role {
            font-size: 14px;
            font-weight: 500;
        }

        .message-content {
            padding-left: 44px;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .message-content pre {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding-left: 44px;
        }

        .file-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tools-used {
            margin-top: 12px;
            padding-left: 44px;
        }

        .tool-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(217, 119, 87, 0.15);
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent);
            margin-right: 6px;
        }

        /* Input area */
        .input-area {
            padding: 16px 24px 24px;
            background: var(--bg-primary);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .drop-zone {
            border: 2px dashed transparent;
            border-radius: 16px;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(217, 119, 87, 0.05);
        }

        .input-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .attached-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px 0;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 13px;
        }

        .attached-file-name {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-file {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-file:hover {
            color: var(--error);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            padding: 12px 16px;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
        }

        .message-input:focus {
            outline: none;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .attach-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .attach-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .stop-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 9px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .stop-btn:hover:not(:disabled) {
            color: var(--error);
            border-color: rgba(248, 113, 113, 0.6);
            background: rgba(248, 113, 113, 0.12);
        }

        .stop-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .send-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-hint {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 12px;
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 44px;
            color: var(--text-secondary);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Status indicator */
        .status-indicator {
            color: var(--text-muted);
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Empty state */
        .no-chats {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Top-right buttons container */
        .top-buttons {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 50;
            display: flex;
            gap: 8px;
        }

        /* Settings button */
        .settings-btn, .artifacts-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .settings-btn:hover, .artifacts-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        /* Artifacts Modal - Full pane */
        .artifacts-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 100;
        }

        .artifacts-modal-overlay.active {
            display: flex;
            flex-direction: column;
        }

        .artifacts-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .artifacts-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tab navigation */
        .explorer-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .explorer-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .explorer-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .explorer-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Sessions list */
        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .session-item:hover {
            background: var(--bg-tertiary);
        }

        .session-icon {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .session-info {
            flex: 1;
            min-width: 0;
        }

        .session-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .session-arrow {
            color: var(--text-muted);
        }

        /* Session viewer */
        .session-viewer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .session-back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .session-back-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .session-viewer-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--text-primary);
        }

        .session-viewer-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .session-entries {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-entry {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        .session-entry-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .session-entry-header:hover {
            background: var(--bg-hover);
        }

        .session-entry-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .session-entry-type.user {
            background: rgba(42, 74, 94, 0.5);
            color: #7fb3d5;
        }

        .session-entry-type.assistant {
            background: rgba(217, 119, 87, 0.2);
            color: var(--accent);
        }

        .session-entry-type.system {
            background: rgba(100, 100, 100, 0.3);
            color: var(--text-muted);
        }

        .session-entry-type.result {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }

        .session-entry-type.tool-use {
            background: rgba(96, 165, 250, 0.2);
            color: #93c5fd;
        }

        .session-entry-type.tool-result {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .session-entry-timestamp {
            margin-left: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .session-entry-content {
            padding: 12px 14px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .session-entry-content.collapsed {
            display: none;
        }

        .session-entry-json {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
        }

        .artifacts-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .artifacts-tree {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .artifacts-tree.drag-over {
            outline: 2px dashed rgba(217, 119, 87, 0.6);
            outline-offset: 6px;
            border-radius: 10px;
        }

        #commandsContent.drag-over,
        #promptsContent.drag-over,
        #scriptsContent.drag-over {
            outline: 2px dashed rgba(217, 119, 87, 0.6);
            outline-offset: -2px;
            border-radius: 10px;
            background: rgba(217, 119, 87, 0.05);
        }

        .artifacts-folder {
            margin-bottom: 8px;
        }

        .artifacts-folder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .artifacts-folder-header:hover {
            background: var(--bg-tertiary);
        }

        .artifacts-folder-header.drag-over {
            background: rgba(217, 119, 87, 0.12);
            outline: 2px dashed rgba(217, 119, 87, 0.7);
            outline-offset: 2px;
        }

        .artifacts-folder-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .artifacts-folder-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .artifacts-folder-contents {
            padding-left: 24px;
            margin-top: 4px;
        }

        .artifacts-file {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .artifacts-file[draggable="true"] {
            cursor: grab;
        }

        .artifacts-file[draggable="true"]:active {
            cursor: grabbing;
        }

        .artifacts-file[draggable="true"] .artifacts-file-name {
            cursor: grab;
        }

        .artifacts-file.dragging {
            opacity: 0.7;
        }

        .artifacts-file:hover {
            background: var(--bg-secondary);
        }

        .artifacts-file-icon {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .artifacts-file-info {
            flex: 1;
            min-width: 0;
        }

        .artifacts-file-name {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artifacts-file-name:hover {
            text-decoration: underline;
        }

        .artifacts-file-url {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artifacts-file-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .artifacts-file-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .artifacts-file-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .artifacts-file-btn.delete:hover {
            color: var(--error);
        }

        .monaco-editor-host {
            height: 65vh;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            background: #1e1e1e;
        }

        .artifacts-empty {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-muted);
        }

        .artifacts-empty-icon {
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .artifacts-empty h3 {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .artifacts-empty p {
            font-size: 14px;
            line-height: 1.5;
        }

        .artifacts-refresh-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.15s;
        }

        .artifacts-refresh-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }

        @media (max-width: 768px) {
            .artifacts-modal-overlay {
                left: 0;
            }
        }

        /* Settings Modal */
        .settings-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .settings-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .settings-section-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100%;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .settings-btn {
                top: 12px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Layout: sidebar + main chat surface + modals -->
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    Cloude ☁️ Agent
                </div>
            </div>

            <div class="model-section">
                <label>Model</label>
                <div class="model-summary">
                    <div class="model-current" id="modelCurrentLabel">Default</div>
                    <button class="model-change-btn" type="button" onclick="openSettingsModal()">Change</button>
                </div>
                <div class="model-default-hint" id="modelDefaultHint">Server default: Unknown</div>
            </div>

            <div class="model-section">
                <label>Permissions</label>
                <label class="checkbox-label">
                    <input type="checkbox" id="bypassPermissions">
                    <span>Bypass all permission checks</span>
                </label>
                <div class="permission-hint">When enabled, Claude can use all tools without approval. Use with caution.</div>
            </div>

            <button class="new-chat-btn" onclick="newChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Chat
            </button>

            <div class="chats-section">
                <h3>Recent Chats</h3>
                <div id="chatsList"></div>
            </div>
        </aside>

        <!-- Main chat surface -->
        <main class="main">
            <!-- Top-right buttons -->
            <div class="top-buttons">
                <button class="artifacts-btn" onclick="openArtifactsModal()" title="Public Artifacts">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                <button class="settings-btn" onclick="openSettingsModal()" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome" id="welcome">
                    <h1>Welcome to Cloude Agent</h1>
                    <p>A cloud-hosted version of the Claude Code Agent.</p>
                </div>
                <div class="messages" id="messages"></div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <div class="drop-zone" id="dropZone">
                        <div class="input-container">
                            <div class="attached-files" id="attachedFiles"></div>
                            <div class="input-row">
                                <textarea 
                                    class="message-input" 
                                    id="messageInput" 
                                    placeholder="Message Cloude Agent..."
                                    rows="1"
                                ></textarea>
                                <div class="input-actions">
                                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                                        </svg>
                                    </button>
                                    <button class="stop-btn" id="stopBtn" onclick="stopStreaming()" title="Stop response" disabled>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                                        </svg>
                                    </button>
                                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(event)">
                    <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Skill Modal -->
    <div class="modal-overlay" id="skillModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="skillModalTitle">Add Skill</h2>
                <button class="modal-close" onclick="closeSkillModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Zip Upload -->
                <div id="uploadSection">
                    <div class="upload-zone" id="skillUploadZone" onclick="document.getElementById('skillZipInput').click()">
                        <div class="upload-zone-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </div>
                        <div class="upload-zone-text" id="uploadZoneText">Drop skill .zip here or click to browse</div>
                        <div class="upload-zone-hint">Zip should contain SKILL.md and any supporting files</div>
                    </div>
                    <input type="file" id="skillZipInput" accept=".zip" hidden onchange="handleSkillZipSelect(event)">
                    
                    <div class="or-divider">or create manually</div>
                </div>

                <!-- Manual Entry -->
                <div id="manualSection">
                    <div class="form-group">
                        <label for="skillId">Skill ID</label>
                        <input type="text" class="form-input" id="skillId" placeholder="my-skill-name">
                        <div class="form-hint">Lowercase, alphanumeric, dashes and underscores only</div>
                    </div>
                    <div class="form-group">
                        <label for="skillContent">SKILL.md Content</label>
                        <textarea class="form-input form-textarea" id="skillContent" placeholder="---
name: My Skill
description: Does something useful when asked about X
---

# My Skill

Instructions for Claude on how to use this skill..."></textarea>
                        <div class="form-hint">Use YAML frontmatter for name and description, then Markdown for instructions</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSkillModal()">Cancel</button>
                <button class="btn btn-primary" id="saveSkillBtn" onclick="saveSkill()">Save Skill</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="settings-body">
                <!-- API URL Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>API URL</h3>
                    </div>
                    <input type="text" class="api-key-input" id="apiUrl" placeholder="https://your-app.up.railway.app">
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                        The base URL of your deployed Cloude Agent API
                    </div>
                </div>
                <!-- API Key Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>API Key</h3>
                    </div>
                    <input type="password" class="api-key-input" id="apiKey" placeholder="Enter your API key...">
                    <div class="api-status disconnected" id="apiStatus">
                        <span class="status-dot"></span>
                        <span id="statusText">Not connected</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>Default Model</h3>
                    </div>
                    <div class="model-picker" id="modelPicker">
                        <div class="model-search-row">
                            <input type="text" class="model-search-input" id="modelSearchInput" placeholder="Search models...">
                            <button class="model-reset-btn" type="button" id="modelResetBtn">Use server default</button>
                        </div>
                        <div class="model-default-hint" id="modelPickerHint">Server default: Unknown</div>
                        <div class="model-dropdown" id="modelDropdown"></div>
                    </div>
                    <div class="model-default-hint" id="modelSelectionHint">Current: Default</div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h3>Prompt Override</h3>
                    </div>
                    <select class="model-select" id="promptSelect">
                        <option value="">Default (CLAUDE.md)</option>
                    </select>
                    <div class="model-default-hint" id="promptSelectionHint">Using CLAUDE.md</div>
                </div>
            </div>
        </div>
    </div>

	    <!-- Explorer Modal (Full-pane) - Skills, Artifacts, Commands, Prompts & Sessions -->
	    <div class="artifacts-modal-overlay" id="artifactsModal">
	        <div class="artifacts-modal-header">
	            <div class="explorer-tabs">
	                <button class="explorer-tab" id="tabClaudeMd" onclick="switchExplorerTab('claude')">CLAUDE.md</button>
	                <button class="explorer-tab" id="tabSkills" onclick="switchExplorerTab('skills')">Skills</button>
	                <button class="explorer-tab active" id="tabArtifacts" onclick="switchExplorerTab('artifacts')">Artifacts</button>
	                <button class="explorer-tab" id="tabCommands" onclick="switchExplorerTab('commands')">Commands</button>
	                <button class="explorer-tab" id="tabPrompts" onclick="switchExplorerTab('prompts')">Prompts</button>
                <button class="explorer-tab" id="tabScripts" onclick="switchExplorerTab('scripts')">Scripts</button>
                <button class="explorer-tab" id="tabSettings" onclick="switchExplorerTab('settings')">Settings</button>
                <button class="explorer-tab" id="tabSessions" onclick="switchExplorerTab('sessions')">Sessions</button>
	            </div>
	            <div style="display: flex; gap: 8px;">
	                <button class="artifacts-refresh-btn" id="explorerRefreshBtn" onclick="refreshCurrentTab()">
	                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh
                </button>
                <button class="modal-close" onclick="closeArtifactsModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="artifacts-modal-body">
            <!-- CLAUDE.md Tab Content -->
            <div id="claudeContent" style="display: none;">
                <div class="artifacts-empty">
                    <h3>CLAUDE.md</h3>
                    <p>Project context loaded from the workspace volume.</p>
                </div>
            </div>
            <!-- Skills Tab Content -->
            <div id="skillsContent" style="display: none;">
                <div class="skills-pane">
                    <div class="skills-pane-header">
                        <div>
                            <div class="skills-pane-title">Skills</div>
                            <div class="skills-pane-subtitle">Install, edit, download, or delete agent skills.</div>
                        </div>
                        <div class="skills-pane-actions">
                            <button class="artifacts-refresh-btn" onclick="openSkillModal()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Skill
                            </button>
                        </div>
                    </div>
                    <div class="skills-drop-zone" id="skillsDropZone">
                        <div class="skills-drop-hint">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 4px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <div>Drop .zip to install</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Or click Add Skill to edit SKILL.md</div>
                        </div>
                        <div class="skills-list" id="skillsList">
                            <div class="no-skills">No skills installed<br><small>Drop a .zip file or click Add Skill</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Artifacts Tab Content -->
            <div id="artifactsContent">
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <h3>No artifacts yet</h3>
                    <p>Claude can save files to /artifacts/ to share them publicly.<br>They'll appear here with clickable links.</p>
                </div>
            </div>
	            <!-- Commands Tab Content -->
	            <div id="commandsContent" style="display: none;">
	                <div class="artifacts-empty">
	                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
	                            <polyline points="4 17 10 11 4 5"/>
                            <line x1="12" y1="19" x2="20" y2="19"/>
                        </svg>
                    </div>
	                    <h3>No commands yet</h3>
	                    <p>Slash commands will appear here.</p>
	                </div>
	            </div>
	            <!-- Prompts Tab Content -->
	            <div id="promptsContent" style="display: none;">
	                <div class="artifacts-empty">
	                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
	                            <path d="M4 19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2z"></path>
	                            <polyline points="14 2 14 8 20 8"></polyline>
	                            <line x1="8" y1="13" x2="16" y2="13"></line>
	                            <line x1="8" y1="17" x2="16" y2="17"></line>
	                        </svg>
	                    </div>
	                    <h3>Prompts</h3>
	                    <p>Prompt overrides stored under <code>prompts/</code></p>
	                </div>
	            </div>
            <!-- Scripts Tab Content -->
            <div id="scriptsContent" style="display: none;">
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
	                            <path d="M4 19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2z"></path>
	                            <polyline points="14 2 14 8 20 8"></polyline>
	                            <line x1="8" y1="13" x2="16" y2="13"></line>
	                            <line x1="8" y1="17" x2="16" y2="17"></line>
	                        </svg>
	                    </div>
                    <h3>Scripts</h3>
                    <p>Helper scripts stored under <code>.claude/scripts/</code></p>
                </div>
            </div>
            <!-- Settings Tab Content -->
            <div id="settingsContent" style="display: none;">
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <h3>Settings</h3>
                    <p>View and edit the runtime settings on the workspace volume.</p>
                </div>
            </div>
            <!-- Sessions Tab Content -->
            <div id="sessionsContent" style="display: none;">
                <div class="artifacts-empty">
	                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <h3>No sessions yet</h3>
                    <p>Claude session logs will appear here.</p>
                </div>
            </div>
        </div>
    </div>

        <script>
            // =========================================================
            // Script map
            // - State + caches
            // - App bootstrap + event wiring
            // - API + connection
            // - Model selection
            // - Prompt overrides
            // - Skills + commands + prompts + scripts
            // - Chat + streaming
            // - Explorer + editors
            // =========================================================

            // State + caches
            let API_URL = localStorage.getItem('clawed_api_url') || '';

            let currentSessionId = null;
            let attachedFiles = [];
            let isLoading = false;
            let isStopping = false;
            let currentStreamController = null;
            let currentStreamReader = null;
            let currentStreamSessionId = null;
            const messageMarkdown = {};
            let skillsContentTemplate = null;

        // App bootstrap
        document.addEventListener('DOMContentLoaded', () => {
            const skillsContentEl = document.getElementById('skillsContent');
            if (skillsContentEl) {
                skillsContentTemplate = skillsContentEl.innerHTML;
            }
            loadApiUrl();
            loadApiKey();
            loadModel();
            loadPromptSelection();
            loadChats();
            loadSkills();
            setupEventListeners();
            autoResizeTextarea();
            setupCommandsDragDrop();
            setupPromptsDragDrop();
            setupScriptsDragDrop();
        });

        // Event wiring + UI helpers
        function installSkillsDropZoneListeners() {
            const skillsDropZone = document.getElementById('skillsDropZone');
            if (!skillsDropZone) return;
            if (skillsDropZone.dataset.listenersInstalled === '1') return;
            skillsDropZone.dataset.listenersInstalled = '1';

            skillsDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                skillsDropZone.classList.add('drag-over');
            });

            skillsDropZone.addEventListener('dragleave', (e) => {
                if (!skillsDropZone.contains(e.relatedTarget)) {
                    skillsDropZone.classList.remove('drag-over');
                }
            });

            skillsDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                skillsDropZone.classList.remove('drag-over');
                handleSkillDrop(e.dataTransfer.files);
            });
        }

        function ensureSkillsPaneTemplate() {
            const skillsList = document.getElementById('skillsList');
            if (skillsList) return;
            const skillsContentEl = document.getElementById('skillsContent');
            if (!skillsContentEl || !skillsContentTemplate) return;
            skillsContentEl.innerHTML = skillsContentTemplate;
            installSkillsDropZoneListeners();
        }

        function setupEventListeners() {
            const input = document.getElementById('messageInput');
            const apiKeyInput = document.getElementById('apiKey');
            const apiUrlInput = document.getElementById('apiUrl');
            const dropZone = document.getElementById('dropZone');

            input.addEventListener('input', () => {
                autoResizeTextarea();
                updateSendButton();
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            apiUrlInput.addEventListener('input', () => {
                saveApiUrl();
                checkConnection();
            });

            apiKeyInput.addEventListener('input', () => {
                saveApiKey();
                checkConnection();
            });

            // Model selection
            setupModelPicker();
            setupPromptSelector();

            // Drag and drop for chat files
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            installSkillsDropZoneListeners();

            // Skill upload zone in modal
            const skillUploadZone = document.getElementById('skillUploadZone');
            skillUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                skillUploadZone.classList.add('drag-over');
            });

            skillUploadZone.addEventListener('dragleave', () => {
                skillUploadZone.classList.remove('drag-over');
            });

            skillUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                skillUploadZone.classList.remove('drag-over');
                handleSkillZipDrop(e.dataTransfer.files);
            });

            setupArtifactsDropHandling();
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const hasContent = input.value.trim() || attachedFiles.length > 0;
            const hasApiKey = document.getElementById('apiKey').value.trim();
            const hasApiUrl = API_URL.trim();
            sendBtn.disabled = !hasContent || !hasApiKey || !hasApiUrl || isLoading;
            if (stopBtn) {
                stopBtn.disabled = !isLoading || isStopping;
            }
        }

        // API URL management
        function loadApiUrl() {
            const saved = localStorage.getItem('clawed_api_url');
            if (saved) {
                document.getElementById('apiUrl').value = saved;
                API_URL = saved;
            }
        }

        function saveApiUrl() {
            let url = document.getElementById('apiUrl').value.trim();
            // Remove trailing slash if present
            if (url.endsWith('/')) {
                url = url.slice(0, -1);
            }
            localStorage.setItem('clawed_api_url', url);
            API_URL = url;
        }

        // API Key management
        function loadApiKey() {
            const saved = localStorage.getItem('clawed_api_key');
            if (saved) {
                document.getElementById('apiKey').value = saved;
                checkConnection();
                loadModelsFromApi();
                loadPromptsFromApi();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('clawed_api_key', key);
        }

        // Model management
        let modelDisplayNames = {};
        let modelsCache = [];
        let selectedModelId = '';
        let defaultModelId = '';
        let defaultModelAlias = 'sonnet';

        // Prompt override management
        let promptDisplayNames = {};
        let promptDescriptions = {};
        let promptsCache = [];
        let selectedPromptId = '';
        function resetPromptCache() {
            promptsCache = [];
            promptDisplayNames = {};
            promptDescriptions = {};
            renderPromptOptions();
        }
        const MODEL_DROPDOWN_LIMIT = 200;
        const MODEL_DROPDOWN_IDLE_LIMIT = 50;

        function getModelDisplayName(modelId) {
            if (!modelId) return '';
            return modelDisplayNames[modelId] || modelId;
        }

        function getDefaultModelHint() {
            if (defaultModelId) {
                const display = getModelDisplayName(defaultModelId);
                const aliasLabel = defaultModelAlias ? ` (${defaultModelAlias})` : '';
                return `Server default${aliasLabel}: ${display}`;
            }
            if (defaultModelAlias) {
                return `Server default (${defaultModelAlias})`;
            }
            return 'Server default';
        }

        function getModelBadgeLabel(modelId) {
            if (modelId) {
                return getModelDisplayName(modelId);
            }
            if (defaultModelId) {
                return `Default: ${getModelDisplayName(defaultModelId)}`;
            }
            if (defaultModelAlias) {
                return `Default (${defaultModelAlias})`;
            }
            return '';
        }

        function updateModelSelectionUI() {
            const currentLabel = document.getElementById('modelCurrentLabel');
            const defaultHint = document.getElementById('modelDefaultHint');
            const pickerHint = document.getElementById('modelPickerHint');
            const selectionHint = document.getElementById('modelSelectionHint');

            const currentText = selectedModelId
                ? getModelDisplayName(selectedModelId)
                : (defaultModelId ? `Default: ${getModelDisplayName(defaultModelId)}` : 'Default');
            if (currentLabel) {
                currentLabel.textContent = currentText;
            }

            const defaultHintText = getDefaultModelHint();
            if (defaultHint) {
                defaultHint.textContent = defaultHintText;
            }
            if (pickerHint) {
                pickerHint.textContent = defaultHintText;
            }
            if (selectionHint) {
                selectionHint.textContent = selectedModelId
                    ? `Current: ${getModelDisplayName(selectedModelId)}`
                    : 'Current: Server default';
            }
        }

        function loadModel() {
            selectedModelId = localStorage.getItem('clawed_model') || '';
            updateModelSelectionUI();
        }

        function setSelectedModel(modelId) {
            selectedModelId = modelId || '';
            if (selectedModelId) {
                localStorage.setItem('clawed_model', selectedModelId);
            } else {
                localStorage.removeItem('clawed_model');
            }
            updateModelSelectionUI();
        }

        function getSelectedModel() {
            return selectedModelId;
        }

        function filterModels(term) {
            const normalized = (term || '').trim().toLowerCase();
            if (!normalized) {
                return modelsCache.slice(0, MODEL_DROPDOWN_IDLE_LIMIT);
            }
            return modelsCache.filter((m) => {
                const id = String(m.id || '').toLowerCase();
                const name = String(m.display_name || '').toLowerCase();
                return id.includes(normalized) || name.includes(normalized);
            }).slice(0, MODEL_DROPDOWN_LIMIT);
        }

        function renderModelDropdown(term) {
            const dropdown = document.getElementById('modelDropdown');
            if (!dropdown) return;
            const matches = filterModels(term);
            const normalized = (term || '').trim().toLowerCase();

            const options = [];
            const defaultSelected = !selectedModelId;
            options.push(`
                <div class="model-option ${defaultSelected ? 'selected' : ''}" data-model-id="">
                    <div class="model-option-name">Default</div>
                    <div class="model-option-id">${escapeHtml(getDefaultModelHint())}</div>
                </div>
            `);

            if (!normalized && modelsCache.length > MODEL_DROPDOWN_IDLE_LIMIT) {
                options.push(`<div class="model-option-empty">Type to filter (${MODEL_DROPDOWN_IDLE_LIMIT} of ${modelsCache.length} shown)</div>`);
            }

            if (matches.length === 0) {
                const emptyText = modelsCache.length ? 'No matching models' : 'No models available';
                options.push(`<div class="model-option-empty">${escapeHtml(emptyText)}</div>`);
            } else {
                for (const m of matches) {
                    const id = m.id || '';
                    const display = getModelDisplayName(id);
                    const selectedClass = id === selectedModelId ? 'selected' : '';
                    options.push(`
                        <div class="model-option ${selectedClass}" data-model-id="${escapeHtml(id)}">
                            <div class="model-option-name">${escapeHtml(display)}</div>
                            <div class="model-option-id">${escapeHtml(id)}</div>
                        </div>
                    `);
                }
            }

            dropdown.innerHTML = options.join('');
        }

        function openModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            if (dropdown) {
                dropdown.classList.add('open');
            }
        }

        function closeModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            if (dropdown) {
                dropdown.classList.remove('open');
            }
        }

        function setupModelPicker() {
            const searchInput = document.getElementById('modelSearchInput');
            const dropdown = document.getElementById('modelDropdown');
            const resetBtn = document.getElementById('modelResetBtn');
            const picker = document.getElementById('modelPicker');

            if (!searchInput || !dropdown) return;

            searchInput.addEventListener('focus', () => {
                renderModelDropdown(searchInput.value);
                openModelDropdown();
            });

            searchInput.addEventListener('input', () => {
                renderModelDropdown(searchInput.value);
                openModelDropdown();
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModelDropdown();
                    searchInput.blur();
                }
            });

            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    setSelectedModel('');
                    searchInput.value = '';
                    closeModelDropdown();
                });
            }

            if (dropdown.dataset.listenersInstalled !== '1') {
                dropdown.dataset.listenersInstalled = '1';
                dropdown.addEventListener('click', (e) => {
                    const option = e.target.closest('.model-option');
                    if (!option) return;
                    const modelId = option.dataset.modelId || '';
                    setSelectedModel(modelId);
                    searchInput.value = '';
                    closeModelDropdown();
                });
            }

            if (picker && picker.dataset.listenersInstalled !== '1') {
                picker.dataset.listenersInstalled = '1';
                document.addEventListener('click', (e) => {
                    if (!picker.contains(e.target)) {
                        closeModelDropdown();
                    }
                });
            }
        }

        async function loadModelsFromApi() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey || !API_URL) {
                modelsCache = [];
                modelDisplayNames = {};
                updateModelSelectionUI();
                renderModelDropdown('');
                return;
            }

            try {
                const resp = await fetch(`${API_URL}/models`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!resp.ok) return;
                const data = await resp.json();
                const models = data.models || [];

                modelsCache = models;
                modelDisplayNames = {};
                for (const m of models) {
                    if (!m.id) continue;
                    modelDisplayNames[m.id] = m.display_name || m.id;
                }

                defaultModelId = data.default_model_id || (data.defaults ? data.defaults.sonnet : '') || defaultModelId;
                defaultModelAlias = data.default_model_alias || defaultModelAlias;
                updateModelSelectionUI();
                renderModelDropdown(document.getElementById('modelSearchInput')?.value || '');
            } catch (e) {
                // ignore; keep existing list
            }
        }

        function loadPromptSelection() {
            selectedPromptId = localStorage.getItem('clawed_prompt_id') || '';
            updatePromptSelectionUI();
        }

        function setSelectedPrompt(promptId) {
            selectedPromptId = promptId || '';
            if (selectedPromptId) {
                localStorage.setItem('clawed_prompt_id', selectedPromptId);
            } else {
                localStorage.removeItem('clawed_prompt_id');
            }
            updatePromptSelectionUI();
        }

        function getSelectedPrompt() {
            return selectedPromptId;
        }

        function updatePromptSelectionUI() {
            const select = document.getElementById('promptSelect');
            if (select && select.value !== selectedPromptId) {
                select.value = selectedPromptId;
            }
            const hint = document.getElementById('promptSelectionHint');
            if (hint) {
                if (selectedPromptId) {
                    const desc = promptDescriptions[selectedPromptId] || 'Custom prompt selected';
                    hint.textContent = desc;
                } else {
                    hint.textContent = 'Using CLAUDE.md';
                }
            }
        }

        function renderPromptOptions() {
            const select = document.getElementById('promptSelect');
            if (!select) return;

            const options = ['<option value="">Default (CLAUDE.md)</option>'];
            const knownIds = new Set();
            for (const prompt of promptsCache) {
                if (!prompt || !prompt.id) continue;
                const id = prompt.id;
                const name = prompt.name || id;
                const desc = prompt.description || '';
                promptDisplayNames[id] = name;
                promptDescriptions[id] = desc;
                knownIds.add(id);
                const label = desc ? `${name} - ${desc}` : name;
                options.push(`<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`);
            }

            select.innerHTML = options.join('');
            if (selectedPromptId && !knownIds.has(selectedPromptId)) {
                setSelectedPrompt('');
            } else {
                updatePromptSelectionUI();
            }
        }

        function setupPromptSelector() {
            const select = document.getElementById('promptSelect');
            if (!select) return;
            if (select.dataset.listenersInstalled === '1') return;
            select.dataset.listenersInstalled = '1';
            select.addEventListener('change', () => {
                setSelectedPrompt(select.value);
            });
        }

        async function loadPromptsFromApi() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey || !API_URL) {
                resetPromptCache();
                return;
            }

            try {
                const resp = await fetch(`${API_URL}/prompts`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!resp.ok) {
                    resetPromptCache();
                    return;
                }
                const data = await resp.json();
                promptsCache = data.prompts || [];
                promptDisplayNames = {};
                promptDescriptions = {};
                renderPromptOptions();
            } catch (e) {
                // ignore; keep existing list
            }
        }

        // Skill management
        let editingSkillId = null;
        let currentSkillExplorer = null;

        async function loadSkills() {
            ensureSkillsPaneTemplate();
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                renderSkills([]);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/skills`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (response.ok) {
                    const data = await response.json();
                    renderSkills(data.skills || []);
                } else {
                    renderSkills([]);
                }
            } catch {
                renderSkills([]);
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function renderSkills(skills) {
            const container = document.getElementById('skillsList');
            
            if (skills.length === 0) {
                container.innerHTML = '<div class="no-skills">No skills installed<br><small>Drop a .zip file or click Add Skill</small></div>';
                return;
            }

            container.innerHTML = skills.map(skill => `
                <div class="skill-item">
                    <div class="skill-item-row">
                        <div class="skill-item-info">
                            <div class="skill-item-name">${escapeHtml(skill.name)}</div>
                            <div class="skill-item-desc">${escapeHtml(skill.description || '')}</div>
                        </div>
                        ${skill.file_count > 1 ? `<span class="skill-file-count">${skill.file_count} files</span>` : ''}
                    </div>
                    <div class="skill-item-actions">
                        <button class="skill-item-btn" onclick="downloadSkill('${skill.id}')" title="Download">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        <button class="skill-item-btn" onclick="openSkillExplorer('${skill.id}', '${encodeURIComponent(skill.name || skill.id)}')" title="Browse files">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </button>
                        <button class="skill-item-btn" onclick="editSkill('${skill.id}')" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="skill-item-btn delete" onclick="deleteSkill('${skill.id}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function openSkillExplorer(skillId, encodedName) {
            const name = decodeURIComponent(encodedName || '') || skillId;
            currentSkillExplorer = { id: skillId, name };
            await loadSkillExplorer();
        }

        async function loadSkillExplorer() {
            if (!currentSkillExplorer || !currentSkillExplorer.id) {
                loadSkills();
                return;
            }

            const apiKey = document.getElementById('apiKey').value;
            const contentEl = document.getElementById('skillsContent');
            if (!apiKey) {
                contentEl.innerHTML = `
                    <div class="artifacts-empty">
                        <h3>Skills</h3>
                        <p>Enter your API key in Settings to view and edit.</p>
                    </div>
                `;
                return;
            }

            const basePath = `.claude/skills/${currentSkillExplorer.id}`;
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

            try {
                const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(basePath)}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!response.ok) {
                    contentEl.innerHTML = '<div class="artifacts-empty"><h3>Failed to load skill files</h3></div>';
                    return;
                }
                const data = await response.json();
                const files = data.files || [];
                renderSkillExplorer(files, basePath);
            } catch (e) {
                contentEl.innerHTML = '<div class="artifacts-empty"><h3>Failed to load skill files</h3></div>';
            }
        }

        function renderSkillExplorer(files, basePath) {
            const contentEl = document.getElementById('skillsContent');
            const skillTitle = currentSkillExplorer ? (currentSkillExplorer.name || currentSkillExplorer.id) : 'Skill';
            const skillId = currentSkillExplorer ? currentSkillExplorer.id : '';

            let html = `
                <div class="skills-pane-header" style="margin-bottom: 12px;">
                    <div>
                        <div class="skills-pane-title">${escapeHtml(skillTitle)}</div>
                        <div class="skills-pane-subtitle">${escapeHtml(basePath)}</div>
                    </div>
                    <div class="skills-pane-actions">
                        <button class="artifacts-refresh-btn" onclick="backToSkillsList()">Back</button>
                        <button class="artifacts-refresh-btn" onclick="downloadSkill('${escapeHtml(skillId)}')">Download</button>
                        <button class="artifacts-refresh-btn" onclick="deleteSkill('${escapeHtml(skillId)}')">Delete</button>
                    </div>
                </div>
            `;

            html += '<div class="artifacts-tree">';
            if (!files || files.length === 0) {
                html += '<div class="artifacts-empty" style="padding: 24px;"><p>(empty)</p></div>';
            } else {
                for (const file of files) {
                    const fullPath = `${basePath}/${file.name}`;
                    if (file.is_dir) {
                        const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        html += `
                            <div class="artifacts-folder">
                                <div class="artifacts-folder-header" onclick="toggleSkillFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
                                    <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
                                </div>
                                <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
                            </div>
                        `;
                    } else {
                        html += renderSkillFileRow(file.name, fullPath);
                    }
                }
            }
            html += '</div>';
            contentEl.innerHTML = html;
        }

        function renderSkillFileRow(name, workspacePath) {
            const encodedPath = encodeURIComponent(workspacePath || '');
            const encodedTitle = encodeURIComponent(name || '');
            const canEdit = isEditableTextFile(workspacePath || name);
            const editBtn = canEdit ? `
                        <button class="artifacts-file-btn" onclick="editSkillWorkspaceFile('${encodedPath}', '${encodedTitle}')" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
            ` : '';

	            return `
	                <div class="artifacts-file" draggable="true" data-workspace-path="${encodedPath}">
	                    <div class="artifacts-file-icon">
	                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
	                            <polyline points="14 2 14 8 20 8"/>
	                        </svg>
                    </div>
                    <div class="artifacts-file-info">
                        <span class="artifacts-file-name">${escapeHtml(name)}</span>
                        <div class="artifacts-file-url">${escapeHtml(workspacePath)}</div>
                    </div>
                    <div class="artifacts-file-actions">
                        ${editBtn}
                        <button class="artifacts-file-btn delete" onclick="deleteSkillWorkspaceFile('${encodedPath}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        async function toggleSkillFolder(path, folderId) {
            const contentsEl = document.getElementById(folderId);
            const chevronEl = document.getElementById(`chevron-${folderId}`);
            if (!contentsEl || !chevronEl) return;

            if (contentsEl.style.display === 'none') {
                contentsEl.style.display = 'block';
                chevronEl.style.transform = 'rotate(90deg)';

                if (contentsEl.innerHTML === '') {
                    contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #888;">Loading...</div>';

                    const apiKey = document.getElementById('apiKey').value;
                    try {
                        const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(path)}`, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const files = data.files || [];
                            contentsEl.innerHTML = renderSkillFolderContents(files, path);
                        } else {
                            contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
                        }
                    } catch (e) {
                        contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
                    }
                }
            } else {
                contentsEl.style.display = 'none';
                chevronEl.style.transform = 'rotate(0deg)';
            }
        }

        function renderSkillFolderContents(files, basePath) {
            if (files.length === 0) {
                return '<div style="padding: 8px 0 8px 20px; color: #888;">(empty)</div>';
            }

            let html = '';
            for (const file of files) {
                const fullPath = `${basePath}/${file.name}`;
                if (file.is_dir) {
                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <div class="artifacts-folder" style="margin-left: 20px;">
                            <div class="artifacts-folder-header" onclick="toggleSkillFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
                            </div>
                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
                        </div>
                    `;
                } else {
                    html += `<div style="margin-left: 20px;">${renderSkillFileRow(file.name, fullPath)}</div>`;
                }
            }
            return html;
        }

        async function editSkillWorkspaceFile(encodedPath, encodedTitle) {
            const path = decodeURIComponent(encodedPath || '');
            const title = decodeURIComponent(encodedTitle || '') || path;
            if (!isEditableTextFile(path)) {
                alert('This file type is not editable in the browser.');
                return;
            }
            await openTextEditor(path, title, { containerId: 'skillsContent', onBack: loadSkillExplorer });
        }

        async function deleteSkillWorkspaceFile(encodedPath) {
            const path = decodeURIComponent(encodedPath || '');
            if (!path) return;
            if (!confirm(`Delete "${path}"?`)) return;
            const ok = await deleteWorkspaceItem(path);
            if (!ok) return;
            await loadSkillExplorer();
        }

        function backToSkillsList() {
            currentSkillExplorer = null;
            loadSkills();
        }

        // Skill zip handling
        let pendingSkillZip = null;

        function handleSkillDrop(files) {
            for (const file of files) {
                if (file.name.endsWith('.zip')) {
                    uploadSkillZip(file);
                    return;
                }
            }
            alert('Please drop a .zip file');
        }

        function handleSkillZipSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleSkillZipDrop([file]);
            }
        }

        function handleSkillZipDrop(files) {
            for (const file of files) {
                if (file.name.endsWith('.zip')) {
                    pendingSkillZip = file;
                    const uploadZone = document.getElementById('skillUploadZone');
                    uploadZone.classList.add('has-file');
                    document.getElementById('uploadZoneText').textContent = file.name;
                    // Hide manual section when zip is selected
                    document.getElementById('manualSection').style.display = 'none';
                    document.getElementById('saveSkillBtn').textContent = 'Upload Skill';
                    return;
                }
            }
            alert('Please drop a .zip file');
        }

        async function uploadSkillZip(file) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/skills/upload`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    loadSkills();
                    alert(`Skill "${data.id}" installed (${data.file_count} files)`);
                } else {
                    alert('Failed to upload skill: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to upload skill: ' + error.message);
            }
        }

        async function downloadSkill(skillId) {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await fetch(`${API_URL}/skills/${skillId}/download`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${skillId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download skill');
                }
            } catch (error) {
                alert('Failed to download skill: ' + error.message);
            }
        }

        function openSkillModal(skillId = null) {
            editingSkillId = skillId;
            pendingSkillZip = null;
            
            // Reset modal state
            document.getElementById('skillModalTitle').textContent = skillId ? 'Edit Skill' : 'Add Skill';
            document.getElementById('skillId').value = '';
            document.getElementById('skillContent').value = '';
            document.getElementById('skillId').disabled = false;
            document.getElementById('manualSection').style.display = 'block';
            document.getElementById('saveSkillBtn').textContent = 'Save Skill';
            
            // Reset upload zone
            const uploadZone = document.getElementById('skillUploadZone');
            uploadZone.classList.remove('has-file');
            document.getElementById('uploadZoneText').textContent = 'Drop skill .zip here or click to browse';
            document.getElementById('skillZipInput').value = '';

            // Hide upload section when editing
            document.getElementById('uploadSection').style.display = skillId ? 'none' : 'block';

            if (skillId) {
                loadSkillForEdit(skillId);
            }

            document.getElementById('skillModal').classList.add('active');
        }

        function closeSkillModal() {
            document.getElementById('skillModal').classList.remove('active');
            editingSkillId = null;
            pendingSkillZip = null;
        }

        // Settings modal functions
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            const searchInput = document.getElementById('modelSearchInput');
            if (searchInput) {
                searchInput.value = '';
                renderModelDropdown('');
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
            closeModelDropdown();
        }

        // Close settings modal on outside click or Escape
        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                closeSettingsModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettingsModal();
                closeSkillModal();
                closeArtifactsModal();
            }
        });

        // Artifacts modal functions
        function openArtifactsModal() {
            document.getElementById('artifactsModal').classList.add('active');
            switchExplorerTab(currentExplorerTab);
        }

        function closeArtifactsModal() {
            document.getElementById('artifactsModal').classList.remove('active');
        }

        async function loadArtifacts() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                renderArtifactsEmpty();
                return;
            }

            const contentEl = document.getElementById('artifactsContent');
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

            try {
                // Fetch only top-level artifacts directory (no recursion)
                const response = await fetch(`${API_URL}/workspace?path=artifacts`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    const files = data.files || [];
                    renderArtifactsList(files, 'artifacts');
                } else {
                    renderArtifactsEmpty();
                }
            } catch (e) {
                console.error('Failed to load artifacts:', e);
                renderArtifactsEmpty();
            }
        }

        function renderArtifactsEmpty() {
            const contentEl = document.getElementById('artifactsContent');
            contentEl.innerHTML = `
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <h3>No artifacts yet</h3>
                    <p>Claude can save files to /artifacts/ to share them publicly.<br>They'll appear here with clickable links.<br>Tip: drag & drop files onto a folder to upload.</p>
                </div>
            `;
        }

        function renderArtifactsList(files, basePath) {
            const contentEl = document.getElementById('artifactsContent');

            if (files.length === 0) {
                renderArtifactsEmpty();
                return;
            }

            let html = '<div class="artifacts-tree">';
            for (const file of files) {
                const fullPath = `${basePath}/${file.name}`;
                if (file.is_dir) {
                    // Folder - clickable to expand (lazy load)
                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <div class="artifacts-folder">
	                            <div class="artifacts-folder-header" data-artifacts-path="${encodeURIComponent(fullPath)}" onclick="toggleArtifactFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
                            </div>
                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
                        </div>
                    `;
                } else {
                    // File
                    const publicPath = fullPath.replace(/^artifacts\//, '');
                    const publicUrl = `${API_URL}/artifacts/${publicPath}`;
                    html += renderArtifactFile(file.name, publicUrl, fullPath);
                }
            }
            html += '</div>';
            contentEl.innerHTML = html;
        }

        async function toggleArtifactFolder(path, folderId) {
            const contentsEl = document.getElementById(folderId);
            const chevronEl = document.getElementById(`chevron-${folderId}`);

            if (contentsEl.style.display === 'none') {
                // Expand - load contents if not already loaded
                contentsEl.style.display = 'block';
                chevronEl.style.transform = 'rotate(90deg)';

                if (contentsEl.innerHTML === '') {
                    contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #888;">Loading...</div>';

                    const apiKey = document.getElementById('apiKey').value;
                    try {
                        const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(path)}`, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const files = data.files || [];
                            contentsEl.innerHTML = renderArtifactFolderContents(files, path);
                        } else {
                            contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
                        }
                    } catch (e) {
                        contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
                    }
                }
            } else {
                // Collapse
                contentsEl.style.display = 'none';
                chevronEl.style.transform = 'rotate(0deg)';
            }
        }

        function renderArtifactFolderContents(files, basePath) {
            if (files.length === 0) {
                return '<div style="padding: 8px 0 8px 20px; color: #888;">(empty)</div>';
            }

            let html = '';
            for (const file of files) {
                const fullPath = `${basePath}/${file.name}`;
                if (file.is_dir) {
                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <div class="artifacts-folder" style="margin-left: 20px;">
	                            <div class="artifacts-folder-header" data-artifacts-path="${encodeURIComponent(fullPath)}" onclick="toggleArtifactFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
                            </div>
                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
                        </div>
                    `;
                } else {
                    const publicPath = fullPath.replace(/^artifacts\//, '');
                    const publicUrl = `${API_URL}/artifacts/${publicPath}`;
                    html += `<div style="margin-left: 20px;">${renderArtifactFile(file.name, publicUrl, fullPath)}</div>`;
                }
            }
            return html;
        }

	        function renderArtifactFile(name, publicUrl, workspacePath) {
	            const encodedPath = encodeURIComponent(workspacePath || '');
	            const encodedTitle = encodeURIComponent(name || '');
	            const canEdit = isEditableTextFile(workspacePath || name);
	            const editBtn = canEdit ? `
                        <button class="artifacts-file-btn" onclick="editArtifactFile('${encodedPath}', '${encodedTitle}')" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
            ` : '';

	            return `
	                <div class="artifacts-file" draggable="true" data-workspace-path="${encodedPath}">
	                    <div class="artifacts-file-icon">
	                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
	                            <polyline points="14 2 14 8 20 8"/>
	                        </svg>
	                    </div>
	                    <div class="artifacts-file-info">
	                        <a href="${escapeHtml(publicUrl)}" target="_blank" rel="noopener" class="artifacts-file-name">${escapeHtml(name)}</a>
	                        <div class="artifacts-file-url">${escapeHtml(publicUrl)}</div>
	                    </div>
                    <div class="artifacts-file-actions">
                        ${editBtn}
                        <button class="artifacts-file-btn delete" onclick="deleteArtifactFile('${encodedPath}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                        <button class="artifacts-file-btn" onclick="copyToClipboard('${escapeHtml(publicUrl)}')" title="Copy URL">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <button class="artifacts-file-btn" onclick="window.open('${escapeHtml(publicUrl)}', '_blank')" title="Open">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        async function editArtifactFile(encodedPath, encodedTitle) {
            const path = decodeURIComponent(encodedPath || '');
            const title = decodeURIComponent(encodedTitle || '') || path;
            if (!isEditableTextFile(path)) {
                alert('This file type is not editable in the browser.');
                return;
            }
            await openTextEditor(path, title, { containerId: 'artifactsContent', onBack: loadArtifacts });
        }

        async function deleteWorkspaceItem(path) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return false;
            }

            try {
                const response = await fetch(`${API_URL}/workspace/${encodeURIComponent(path)}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });
                if (response.ok) return true;

                let detail = '';
                try {
                    const data = await response.json();
                    detail = data.detail || '';
                } catch (e) {}
                alert(`Delete failed${detail ? ': ' + detail : ''}`);
                return false;
            } catch (e) {
                alert('Delete failed: ' + e.message);
                return false;
            }
        }

        function getPathBasename(path) {
            const p = String(path || '').replace(/\/+$/, '');
            const idx = p.lastIndexOf('/');
            return idx >= 0 ? p.slice(idx + 1) : p;
        }

        function getPathDirname(path) {
            const p = String(path || '').replace(/\/+$/, '');
            const idx = p.lastIndexOf('/');
            return idx >= 0 ? p.slice(0, idx) : '';
        }

	        async function moveWorkspaceItem(srcPath, dstPath, overwrite = false) {
	            const apiKey = document.getElementById('apiKey').value;
	            if (!apiKey) {
	                alert('Please enter your API key first');
	                return null;
	            }

            try {
                const response = await fetch(`${API_URL}/workspace/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ src: srcPath, dst: dstPath, overwrite: !!overwrite })
                });

                let data = {};
	                try {
	                    data = await response.json();
	                } catch (e) {}

	                if (!response.ok) {
	                    if (response.status === 409 && !overwrite) {
	                        const ok = confirm(`"${dstPath}" already exists.\n\nOverwrite it?`);
	                        if (!ok) return null;
	                        return await moveWorkspaceItem(srcPath, dstPath, true);
	                    }
	                    const msg = data.detail || 'Unknown error';
	                    alert(`Move failed: ${msg}`);
	                    return null;
	                }

	                return data;
            } catch (e) {
                alert('Move failed: ' + e.message);
                return null;
            }
        }

        async function deleteArtifactFile(encodedPath) {
            const path = decodeURIComponent(encodedPath || '');
            if (!path) return;
            if (!confirm(`Delete "${path}"?`)) return;
            const ok = await deleteWorkspaceItem(path);
            if (!ok) return;

            const parentDir = path.includes('/') ? path.split('/').slice(0, -1).join('/') : 'artifacts';
            await refreshArtifactsAfterUpload(parentDir || 'artifacts');
        }

        let artifactsDropHandlingInstalled = false;
        let artifactsInternalDragSrc = null;

        function artifactFolderIdFromPath(path) {
            return `folder-${String(path || '').replace(/[^a-zA-Z0-9]/g, '-')}`;
        }

        function setupArtifactsDropHandling() {
            if (artifactsDropHandlingInstalled) return;
            const contentEl = document.getElementById('artifactsContent');
            if (!contentEl) return;
            artifactsDropHandlingInstalled = true;

            let activeHeader = null;
            const internalDragType = 'application/x-clawed-workspace-path';
            const internalDragTextPrefix = 'clawed-workspace:';

            const clearDragState = () => {
                if (activeHeader) activeHeader.classList.remove('drag-over');
                activeHeader = null;
                const treeEl = contentEl.querySelector('.artifacts-tree');
                if (treeEl) treeEl.classList.remove('drag-over');
            };

            const handleDragStart = (e) => {
                if (currentExplorerTab !== 'artifacts') return;
                const target = e.target;
                if (!(target instanceof Element)) return;
                const row = target.closest('.artifacts-file[draggable="true"]');
                if (!row || !contentEl.contains(row)) return;
                const encoded = row.dataset.workspacePath || '';
                if (!encoded) return;
                let srcPath = '';
                try {
                    srcPath = decodeURIComponent(encoded);
                } catch (err) {
                    srcPath = encoded;
                }
                if (!srcPath || !srcPath.startsWith('artifacts/')) return;

                artifactsInternalDragSrc = srcPath;
                row.classList.add('dragging');

                if (e.dataTransfer) {
                    try {
                        e.dataTransfer.setData(internalDragType, srcPath);
                    } catch (e) {}
                    try {
                        e.dataTransfer.setData('text/plain', `${internalDragTextPrefix}${srcPath}`);
                    } catch (e) {}
                    e.dataTransfer.effectAllowed = 'move';
                }
            };

            const handleDragEnd = (e) => {
                const target = e.target;
                if (!(target instanceof Element)) return;
                const row = target.closest('.artifacts-file.dragging');
                if (row) row.classList.remove('dragging');
                artifactsInternalDragSrc = null;
                clearDragState();
            };

            // Use capture so we reliably observe dragstart/dragend across browsers.
            document.addEventListener('dragstart', handleDragStart, true);
            document.addEventListener('dragend', handleDragEnd, true);

            contentEl.addEventListener('dragover', (e) => {
                if (currentExplorerTab !== 'artifacts') return;
                e.preventDefault();
                e.stopPropagation();

                if (e.dataTransfer) {
                    const types = Array.from(e.dataTransfer.types || []);
                    const isInternal = !!artifactsInternalDragSrc || types.includes(internalDragType);
                    e.dataTransfer.dropEffect = isInternal ? 'move' : 'copy';
                }

                const treeEl = contentEl.querySelector('.artifacts-tree');
                if (treeEl) treeEl.classList.add('drag-over');

                const header = e.target.closest('.artifacts-folder-header');
                if (activeHeader && header !== activeHeader) activeHeader.classList.remove('drag-over');
                if (header) {
                    header.classList.add('drag-over');
                    activeHeader = header;
                } else {
                    activeHeader = null;
                }
            });

            contentEl.addEventListener('dragleave', (e) => {
                if (currentExplorerTab !== 'artifacts') return;
                if (!e.relatedTarget || !contentEl.contains(e.relatedTarget)) {
                    clearDragState();
                }
            });

            contentEl.addEventListener('drop', async (e) => {
                if (currentExplorerTab !== 'artifacts') return;
                e.preventDefault();
                e.stopPropagation();
                clearDragState();

                let internalSrc = e.dataTransfer ? (e.dataTransfer.getData(internalDragType) || '') : '';
                if (!internalSrc && e.dataTransfer) {
                    const text = e.dataTransfer.getData('text/plain') || '';
                    if (text.startsWith(internalDragTextPrefix)) {
                        internalSrc = text.slice(internalDragTextPrefix.length);
                    }
                }
                if (!internalSrc && artifactsInternalDragSrc) {
                    internalSrc = artifactsInternalDragSrc;
                }
                artifactsInternalDragSrc = null;

                let header = e.target.closest('.artifacts-folder-header');
                if (!header) {
                    const folder = e.target.closest('.artifacts-folder');
                    if (folder) header = folder.querySelector(':scope > .artifacts-folder-header');
                }

                let targetPath = 'artifacts';
                const encoded = header?.dataset?.artifactsPath;
                if (encoded) {
                    try {
                        targetPath = decodeURIComponent(encoded);
                    } catch (err) {
                        targetPath = 'artifacts';
                    }
                }

                if (internalSrc) {
                    const srcPath = String(internalSrc || '').replace(/^\/+/, '');
                    if (!srcPath.startsWith('artifacts/')) return;
                    if (!String(targetPath || '').startsWith('artifacts')) targetPath = 'artifacts';

                    const destDir = String(targetPath || 'artifacts').replace(/\/+$/, '');
                    const destPath = `${destDir}/${getPathBasename(srcPath)}`.replace(/^\/+/, '');
                    if (destPath === srcPath) return;

                    const result = await moveWorkspaceItem(srcPath, destPath, false);
                    if (!result) return;

                    const fromDir = getPathDirname(srcPath) || 'artifacts';
                    await refreshArtifactsAfterUpload(fromDir);
                    if (destDir !== fromDir) {
                        await refreshArtifactsAfterUpload(destDir);
                    }
                    return;
                }

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                await uploadArtifactsFiles(files, targetPath);
            });
        }

        async function uploadArtifactsFiles(fileList, targetDir) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const files = Array.from(fileList || []).filter(f => f && f.name);
            if (files.length === 0) return;

            const formData = new FormData();
            formData.append('target_dir', targetDir || 'artifacts');
            for (const f of files) formData.append('files', f);

            const refreshBtn = document.getElementById('explorerRefreshBtn');
            const prevDisabled = refreshBtn ? refreshBtn.disabled : false;
            if (refreshBtn) refreshBtn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/artifacts/upload`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey },
                    body: formData
                });

                let data = {};
                try {
                    data = await response.json();
                } catch (e) {}

                if (!response.ok) {
                    alert('Upload failed: ' + (data.detail || 'Unknown error'));
                    return;
                }

                await refreshArtifactsAfterUpload(targetDir);
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
                if (refreshBtn) refreshBtn.disabled = prevDisabled;
            }
        }

        async function refreshArtifactsAfterUpload(targetDir) {
            const apiKey = document.getElementById('apiKey').value;
            const normalized = String(targetDir || '').trim().replace(/^\/+/, '').replace(/\/+$/, '');
            if (!normalized || normalized === 'artifacts') {
                await loadArtifacts();
                return;
            }

            const folderId = artifactFolderIdFromPath(normalized);
            const contentsEl = document.getElementById(folderId);
            if (!contentsEl) {
                await loadArtifacts();
                return;
            }

            contentsEl.innerHTML = '';
            if (contentsEl.style.display === 'none') return;

            try {
                const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(normalized)}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!response.ok) return;
                const data = await response.json();
                const files = data.files || [];
                contentsEl.innerHTML = renderArtifactFolderContents(files, normalized);
            } catch (e) {
            }
        }

        // Upload files to a workspace directory (for commands/prompts/scripts)
        async function uploadWorkspaceFiles(fileList, targetDir) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const files = Array.from(fileList || []).filter(f => f && f.name);
            if (files.length === 0) return;

            let successCount = 0;
            let errors = [];

            for (const file of files) {
                const safeName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '-');
                const filePath = `${targetDir}/${safeName}`;

                try {
                    const content = await file.text();
                    const response = await fetch(`${API_URL}/workspace/${encodeURIComponent(filePath)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey
                        },
                        body: JSON.stringify({ content })
                    });

                    if (!response.ok) {
                        const data = await response.json().catch(() => ({}));
                        errors.push(`${file.name}: ${data.detail || 'Unknown error'}`);
                    } else {
                        successCount++;
                    }
                } catch (e) {
                    errors.push(`${file.name}: ${e.message}`);
                }
            }

            if (errors.length > 0) {
                alert(`Upload completed with errors:\n${errors.join('\n')}`);
            }

            return successCount > 0;
        }

        // Setup drag-drop for commands tab
        function setupCommandsDragDrop() {
            const contentEl = document.getElementById('commandsContent');
            if (!contentEl) return;

            contentEl.addEventListener('dragover', (e) => {
                if (currentExplorerTab !== 'commands') return;
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
                contentEl.classList.add('drag-over');
            });

            contentEl.addEventListener('dragleave', (e) => {
                if (currentExplorerTab !== 'commands') return;
                if (!e.relatedTarget || !contentEl.contains(e.relatedTarget)) {
                    contentEl.classList.remove('drag-over');
                }
            });

            contentEl.addEventListener('drop', async (e) => {
                if (currentExplorerTab !== 'commands') return;
                e.preventDefault();
                e.stopPropagation();
                contentEl.classList.remove('drag-over');

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                // Filter to only .md files for commands
                const mdFiles = Array.from(files).filter(f => f.name.endsWith('.md'));
                if (mdFiles.length === 0) {
                    alert('Please drop .md files for slash commands');
                    return;
                }

                const uploaded = await uploadWorkspaceFiles(mdFiles, '.claude/commands');
                if (uploaded) {
                    await loadCommands();
                }
            });
        }

        // Setup drag-drop for prompts tab
        function setupPromptsDragDrop() {
            const contentEl = document.getElementById('promptsContent');
            if (!contentEl) return;

            contentEl.addEventListener('dragover', (e) => {
                if (currentExplorerTab !== 'prompts') return;
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
                contentEl.classList.add('drag-over');
            });

            contentEl.addEventListener('dragleave', (e) => {
                if (currentExplorerTab !== 'prompts') return;
                if (!e.relatedTarget || !contentEl.contains(e.relatedTarget)) {
                    contentEl.classList.remove('drag-over');
                }
            });

            contentEl.addEventListener('drop', async (e) => {
                if (currentExplorerTab !== 'prompts') return;
                e.preventDefault();
                e.stopPropagation();
                contentEl.classList.remove('drag-over');

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                const mdFiles = Array.from(files).filter(f => f.name.endsWith('.md'));
                if (mdFiles.length === 0) {
                    alert('Please drop .md files for prompts');
                    return;
                }

                const uploaded = await uploadWorkspaceFiles(mdFiles, 'prompts');
                if (uploaded) {
                    await loadPromptFiles();
                }
            });
        }

        // Setup drag-drop for scripts tab
        function setupScriptsDragDrop() {
            const contentEl = document.getElementById('scriptsContent');
            if (!contentEl) return;

            contentEl.addEventListener('dragover', (e) => {
                if (currentExplorerTab !== 'scripts') return;
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
                contentEl.classList.add('drag-over');
            });

            contentEl.addEventListener('dragleave', (e) => {
                if (currentExplorerTab !== 'scripts') return;
                if (!e.relatedTarget || !contentEl.contains(e.relatedTarget)) {
                    contentEl.classList.remove('drag-over');
                }
            });

            contentEl.addEventListener('drop', async (e) => {
                if (currentExplorerTab !== 'scripts') return;
                e.preventDefault();
                e.stopPropagation();
                contentEl.classList.remove('drag-over');

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                // Filter to script files (.sh, .py)
                const scriptFiles = Array.from(files).filter(f =>
                    f.name.endsWith('.sh') || f.name.endsWith('.py')
                );
                if (scriptFiles.length === 0) {
                    alert('Please drop .sh or .py files for scripts');
                    return;
                }

                const uploaded = await uploadWorkspaceFiles(scriptFiles, '.claude/scripts');
                if (uploaded) {
                    await loadScripts();
                }
            });
        }

        // Text editor (Monaco, with textarea fallback)
        let currentEditingFilePath = null;
        let currentEditorContainerId = 'commandsContent';
        let currentEditorOnBack = null;
        let currentEditorAfterSave = null;

        let monacoEditorInstance = null;
        let monacoModelInstance = null;
        let monacoLoadingPromise = null;
        const MONACO_CDN_BASE = 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min';

        function disposeMonacoEditor() {
            try {
                if (monacoEditorInstance) {
                    monacoEditorInstance.dispose();
                }
            } catch (e) {}
            monacoEditorInstance = null;

            try {
                if (monacoModelInstance) {
                    monacoModelInstance.dispose();
                }
            } catch (e) {}
            monacoModelInstance = null;
        }

        function ensureMonacoLoaderLoaded() {
            if (window.require && window.require.config) return Promise.resolve();

            const existing = document.querySelector('script[data-monaco-loader="1"]');
            if (existing) {
                return new Promise((resolve, reject) => {
                    existing.addEventListener('load', () => resolve());
                    existing.addEventListener('error', () => reject(new Error('Failed to load Monaco loader')));
                });
            }

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${MONACO_CDN_BASE}/vs/loader.js`;
                script.async = true;
                script.setAttribute('data-monaco-loader', '1');
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Monaco loader'));
                document.head.appendChild(script);
            });
        }

        function loadMonacoExtraLanguages() {
            if (!window.require) return;
            const extra = [
                'vs/basic-languages/python/python.contribution',
                'vs/basic-languages/shell/shell.contribution',
                'vs/basic-languages/yaml/yaml.contribution',
                'vs/basic-languages/toml/toml.contribution',
                'vs/basic-languages/ini/ini.contribution',
                'vs/basic-languages/dockerfile/dockerfile.contribution',
                'vs/basic-languages/sql/sql.contribution',
            ];
            for (const mod of extra) {
                try {
                    window.require([mod], () => {}, () => {});
                } catch (e) {}
            }
        }

        function ensureMonacoLoaded() {
            if (window.monaco && window.monaco.editor) return Promise.resolve(window.monaco);
            if (monacoLoadingPromise) return monacoLoadingPromise;

            monacoLoadingPromise = (async () => {
                await ensureMonacoLoaderLoaded();
                if (!window.require || !window.require.config) {
                    throw new Error('Monaco loader not available');
                }

                window.MonacoEnvironment = window.MonacoEnvironment || {};
                if (!window.MonacoEnvironment.getWorkerUrl) {
                    window.MonacoEnvironment.getWorkerUrl = function(workerId, label) {
                        const baseUrl = `${MONACO_CDN_BASE}/`;
                        const src = `
                            self.MonacoEnvironment = { baseUrl: '${baseUrl}' };
                            importScripts('${MONACO_CDN_BASE}/vs/base/worker/workerMain.js');
                        `;
                        return `data:text/javascript;charset=utf-8,${encodeURIComponent(src)}`;
                    };
                }

                window.require.config({ paths: { vs: `${MONACO_CDN_BASE}/vs` } });

                await new Promise((resolve, reject) => {
                    window.require(['vs/editor/editor.main'], () => resolve(), (err) => reject(err));
                });

                loadMonacoExtraLanguages();
                return window.monaco;
            })();

            return monacoLoadingPromise;
        }

        function getMonacoLanguageForPath(path) {
            const name = (String(path || '').split('/').pop() || '').toLowerCase();
            if (name === 'dockerfile' || name.startsWith('dockerfile.')) return 'dockerfile';
            if (name === 'makefile') return 'makefile';
            if (name === '.gitignore' || name === '.gitattributes') return 'plaintext';

            const ext = name.includes('.') ? name.split('.').pop() : '';
            const map = {
                'txt': 'plaintext',
                'md': 'markdown',
                'markdown': 'markdown',
                'json': 'json',
                'py': 'python',
                'js': 'javascript',
                'jsx': 'javascript',
                'ts': 'typescript',
                'tsx': 'typescript',
                'html': 'html',
                'htm': 'html',
                'css': 'css',
                'scss': 'scss',
                'yml': 'yaml',
                'yaml': 'yaml',
                'toml': 'toml',
                'ini': 'ini',
                'cfg': 'ini',
                'conf': 'ini',
                'sh': 'shell',
                'bash': 'shell',
                'zsh': 'shell',
                'sql': 'sql',
                'xml': 'xml',
                'csv': 'plaintext',
                'log': 'plaintext',
            };
            return map[ext] || 'plaintext';
        }

        function isEditableTextFile(path) {
            const name = (String(path || '').split('/').pop() || '').toLowerCase();
            if (!name || name === '.' || name === '..') return false;
            if (name === 'dockerfile' || name.startsWith('dockerfile.')) return true;
            if (name === 'makefile' || name === '.gitignore' || name === '.gitattributes' || name === '.env') return true;

            const ext = name.includes('.') ? name.split('.').pop() : '';
            const editableExts = new Set([
                'txt', 'md', 'markdown', 'json', 'py', 'js', 'jsx', 'ts', 'tsx', 'html', 'htm', 'css', 'scss',
                'yml', 'yaml', 'toml', 'ini', 'cfg', 'conf', 'sh', 'bash', 'zsh', 'sql', 'xml', 'csv', 'log',
            ]);
            return editableExts.has(ext);
        }

        async function loadCommands() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                renderCommandsEmpty();
                return;
            }

            const contentEl = document.getElementById('commandsContent');
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

            try {
                const response = await fetch(`${API_URL}/commands`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderCommandsList(data.commands || []);
                } else {
                    renderCommandsEmpty();
                }
            } catch (e) {
                console.error('Failed to load commands:', e);
                renderCommandsEmpty();
            }
        }

        function renderCommandsEmpty() {
            const contentEl = document.getElementById('commandsContent');
            contentEl.innerHTML = `
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="4 17 10 11 4 5"/>
                            <line x1="12" y1="19" x2="20" y2="19"/>
                        </svg>
                    </div>
                    <h3>No commands yet</h3>
                    <p>Slash commands can be created via the API or by editing a file in .claude/commands/</p>
                    <button class="artifacts-refresh-btn" style="margin-top: 12px;" onclick="promptOpenWorkspaceFile()">Open file path</button>
                </div>
            `;
        }

        function renderCommandsList(commands) {
            const contentEl = document.getElementById('commandsContent');

            if (commands.length === 0) {
                renderCommandsEmpty();
                return;
            }

            let html = `
                <div class="skills-pane-header" style="margin-bottom: 12px;">
                    <div>
                        <div class="skills-pane-title">Commands</div>
                        <div class="skills-pane-subtitle">Edit slash command templates stored under .claude/commands/</div>
                    </div>
                    <div class="skills-pane-actions">
                        <button class="artifacts-refresh-btn" onclick="promptOpenWorkspaceFile()">Open file path</button>
                    </div>
                </div>
                <div class="artifacts-tree">
            `;

            for (const cmd of commands) {
                const workspacePath = cmd.relative_path || toWorkspaceRelative(cmd.path) || `.claude/commands/${cmd.id}.md`;
                html += `
                    <div class="artifacts-file">
                        <div class="artifacts-file-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 17 10 11 4 5"/>
                                <line x1="12" y1="19" x2="20" y2="19"/>
                            </svg>
                        </div>
                        <div class="artifacts-file-info">
                            <span class="artifacts-file-name">/${escapeHtml(cmd.id)}</span>
                            <div class="artifacts-file-url">${escapeHtml(workspacePath)}</div>
                        </div>
                        <div class="artifacts-file-actions">
                            <button class="artifacts-file-btn" onclick="openCommandEditor('${escapeHtml(cmd.id)}', '${encodeURIComponent(workspacePath)}')" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="4 17 10 11 4 5"/>
                                    <line x1="12" y1="19" x2="20" y2="19"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            contentEl.innerHTML = html;
        }

        function toWorkspaceRelative(path) {
            if (!path) return '';
            const marker = "/workspace/";
            const idx = path.indexOf(marker);
            if (idx !== -1) {
                return path.slice(idx + marker.length);
            }
            return path.replace(/^\/+/, "");
        }

	        function promptOpenWorkspaceFile() {
	            const input = prompt("Enter workspace-relative path to edit (e.g. .claude/commands/foo.md or .claude/scripts/foo.sh):");
	            if (input) {
	                openTextEditor(input.trim(), input.trim());
	            }
	        }

	        async function openCommandEditor(cmdId, encodedPath) {
	            const path = decodeURIComponent(encodedPath);
	            openTextEditor(path, `/${cmdId}`);
	        }

	        async function loadPromptFiles() {
	            const apiKey = document.getElementById('apiKey').value;
	            if (!apiKey) {
	                renderPromptFilesEmpty();
	                return;
	            }

	            const contentEl = document.getElementById('promptsContent');
	            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

	            const basePath = 'prompts';
	            try {
	                const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(basePath)}`, {
	                    headers: { 'X-API-Key': apiKey }
	                });

	                if (response.ok) {
	                    const data = await response.json();
	                    renderPromptFilesList(data.files || [], basePath);
	                } else {
	                    renderPromptFilesEmpty();
	                }
	            } catch (e) {
	                console.error('Failed to load prompts:', e);
	                renderPromptFilesEmpty();
	            }
	        }

	        function renderPromptFilesEmpty() {
	            const contentEl = document.getElementById('promptsContent');
	            contentEl.innerHTML = `
	                <div class="artifacts-empty">
	                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
	                            <path d="M4 19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2z"></path>
	                            <polyline points="14 2 14 8 20 8"></polyline>
	                            <line x1="8" y1="13" x2="16" y2="13"></line>
	                            <line x1="8" y1="17" x2="16" y2="17"></line>
	                        </svg>
	                    </div>
	                    <h3>No prompts found</h3>
	                    <p>Prompt overrides live under <code>prompts/</code></p>
	                    <button class="artifacts-refresh-btn" style="margin-top: 12px;" onclick="promptOpenWorkspaceFile()">Open file path</button>
	                </div>
	            `;
	        }

	        function shouldHidePromptItem(name) {
	            const n = String(name || '');
	            return n === '__pycache__' || n === '.DS_Store' || n.endsWith('.pyc');
	        }

	        function renderPromptFilesList(files, basePath) {
	            const contentEl = document.getElementById('promptsContent');

	            const visible = (files || []).filter(f => f && !shouldHidePromptItem(f.name));
	            let html = `
	                <div class="skills-pane-header" style="margin-bottom: 12px;">
	                    <div>
	                        <div class="skills-pane-title">Prompts</div>
	                        <div class="skills-pane-subtitle">Edit prompt overrides stored under <code>${escapeHtml(basePath)}</code></div>
	                    </div>
	                    <div class="skills-pane-actions">
	                        <button class="artifacts-refresh-btn" onclick="promptOpenWorkspaceFile()">Open file path</button>
	                    </div>
	                </div>
	                <div class="artifacts-tree">
	            `;

	            if (visible.length === 0) {
	                html += '<div style="padding: 12px; color: #888;">(empty)</div></div>';
	                contentEl.innerHTML = html;
	                return;
	            }

	            for (const file of visible) {
	                const fullPath = `${basePath}/${file.name}`;
	                if (file.is_dir) {
	                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
	                    html += `
	                        <div class="artifacts-folder">
	                            <div class="artifacts-folder-header" onclick="togglePromptFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
	                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
	                                    <polyline points="9 18 15 12 9 6"></polyline>
	                                </svg>
	                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
	                                </svg>
	                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
	                            </div>
	                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
	                        </div>
	                    `;
	                } else {
	                    html += renderPromptFileRow(file.name, fullPath);
	                }
	            }

	            html += '</div>';
	            contentEl.innerHTML = html;
	        }

	        function renderPromptFolderContents(files, basePath) {
	            const visible = (files || []).filter(f => f && !shouldHidePromptItem(f.name));
	            if (visible.length === 0) {
	                return '<div style="padding: 8px 0 8px 20px; color: #888;">(empty)</div>';
	            }

	            let html = '';
	            for (const file of visible) {
	                const fullPath = `${basePath}/${file.name}`;
	                if (file.is_dir) {
	                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
	                    html += `
	                        <div class="artifacts-folder" style="margin-left: 20px;">
	                            <div class="artifacts-folder-header" onclick="togglePromptFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
	                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
	                                    <polyline points="9 18 15 12 9 6"></polyline>
	                                </svg>
	                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
	                                </svg>
	                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
	                            </div>
	                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
	                        </div>
	                    `;
	                } else {
	                    html += `<div style="margin-left: 20px;">${renderPromptFileRow(file.name, fullPath)}</div>`;
	                }
	            }
	            return html;
	        }

	        function renderPromptFileRow(name, workspacePath) {
	            const encodedPath = encodeURIComponent(workspacePath || '');
	            const encodedTitle = encodeURIComponent(name || '');
	            const canEdit = isEditableTextFile(workspacePath || name);
	            const editBtn = canEdit ? `
	                        <button class="artifacts-file-btn" onclick="editPromptWorkspaceFile('${encodedPath}', '${encodedTitle}')" title="Edit">
	                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
	                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
	                            </svg>
	                        </button>
	            ` : '';

	            return `
	                <div class="artifacts-file">
	                    <div class="artifacts-file-icon">
	                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
	                            <polyline points="14 2 14 8 20 8"/>
	                        </svg>
	                    </div>
	                    <div class="artifacts-file-info">
	                        <span class="artifacts-file-name">${escapeHtml(name)}</span>
	                        <div class="artifacts-file-url">${escapeHtml(workspacePath)}</div>
	                    </div>
	                    <div class="artifacts-file-actions">
	                        ${editBtn}
	                        <button class="artifacts-file-btn delete" onclick="deletePromptWorkspaceFile('${encodedPath}')" title="Delete">
	                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <polyline points="3 6 5 6 21 6"></polyline>
	                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `;
	        }

	        async function togglePromptFolder(path, folderId) {
	            const contentsEl = document.getElementById(folderId);
	            const chevronEl = document.getElementById(`chevron-${folderId}`);
	            if (!contentsEl || !chevronEl) return;

	            if (contentsEl.style.display === 'none') {
	                contentsEl.style.display = 'block';
	                chevronEl.style.transform = 'rotate(90deg)';

	                if (contentsEl.innerHTML === '') {
	                    contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #888;">Loading...</div>';
	                    const apiKey = document.getElementById('apiKey').value;
	                    try {
	                        const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(path)}`, {
	                            headers: { 'X-API-Key': apiKey }
	                        });
	                        if (response.ok) {
	                            const data = await response.json();
	                            const files = data.files || [];
	                            contentsEl.innerHTML = renderPromptFolderContents(files, path);
	                        } else {
	                            contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
	                        }
	                    } catch (e) {
	                        contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
	                    }
	                }
	            } else {
	                contentsEl.style.display = 'none';
	                chevronEl.style.transform = 'rotate(0deg)';
	            }
	        }

	        async function editPromptWorkspaceFile(encodedPath, encodedTitle) {
	            const path = decodeURIComponent(encodedPath || '');
	            const title = decodeURIComponent(encodedTitle || '') || path;
	            if (!isEditableTextFile(path)) {
	                alert('This file type is not editable in the browser.');
	                return;
	            }
	            await openTextEditor(path, title, { containerId: 'promptsContent', onBack: loadPromptFiles });
	        }

	        async function deletePromptWorkspaceFile(encodedPath) {
	            const path = decodeURIComponent(encodedPath || '');
	            if (!path) return;
	            if (!confirm(`Delete "${path}"?`)) return;
	            const ok = await deleteWorkspaceItem(path);
	            if (!ok) return;
	            await loadPromptFiles();
	        }

		        async function loadScripts() {
		            const apiKey = document.getElementById('apiKey').value;
		            if (!apiKey) {
		                renderScriptsEmpty();
	                return;
	            }

		            const contentEl = document.getElementById('scriptsContent');
		            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

		            const basePath = '.claude/scripts';
		            try {
		                const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(basePath)}`, {
		                    headers: { 'X-API-Key': apiKey }
		                });

		                if (response.ok) {
		                    const data = await response.json();
		                    renderScriptsList(data.files || [], basePath);
		                } else {
		                    renderScriptsEmpty();
		                }
		            } catch (e) {
		                console.error('Failed to load scripts:', e);
		                renderScriptsEmpty();
		            }
		        }

	        function renderScriptsEmpty() {
	            const contentEl = document.getElementById('scriptsContent');
	            contentEl.innerHTML = `
	                <div class="artifacts-empty">
	                    <div class="artifacts-empty-icon">
	                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
	                            <path d="M4 19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2z"></path>
	                            <polyline points="14 2 14 8 20 8"></polyline>
	                            <line x1="8" y1="13" x2="16" y2="13"></line>
	                            <line x1="8" y1="17" x2="16" y2="17"></line>
	                        </svg>
	                    </div>
	                    <h3>No scripts found</h3>
	                    <p>Scripts live under <code>.claude/scripts/</code></p>
	                    <button class="artifacts-refresh-btn" style="margin-top: 12px;" onclick="promptOpenWorkspaceFile()">Open file path</button>
	                </div>
	            `;
	        }

	        function shouldHideScriptsItem(name) {
	            const n = String(name || '');
	            return n === '__pycache__' || n === '.DS_Store' || n.endsWith('.pyc');
	        }

	        function renderScriptsList(files, basePath) {
	            const contentEl = document.getElementById('scriptsContent');

	            const visible = (files || []).filter(f => f && !shouldHideScriptsItem(f.name));
	            let html = `
	                <div class="skills-pane-header" style="margin-bottom: 12px;">
	                    <div>
	                        <div class="skills-pane-title">Scripts</div>
	                        <div class="skills-pane-subtitle">Edit helper scripts stored under <code>${escapeHtml(basePath)}</code></div>
	                    </div>
	                    <div class="skills-pane-actions">
	                        <button class="artifacts-refresh-btn" onclick="promptOpenWorkspaceFile()">Open file path</button>
	                    </div>
	                </div>
	                <div class="artifacts-tree">
	            `;

	            if (visible.length === 0) {
	                html += '<div style="padding: 12px; color: #888;">(empty)</div></div>';
	                contentEl.innerHTML = html;
	                return;
	            }

	            for (const file of visible) {
	                const fullPath = `${basePath}/${file.name}`;
	                if (file.is_dir) {
	                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
	                    html += `
	                        <div class="artifacts-folder">
	                            <div class="artifacts-folder-header" onclick="toggleScriptsFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
	                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
	                                    <polyline points="9 18 15 12 9 6"></polyline>
	                                </svg>
	                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
	                                </svg>
	                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
	                            </div>
	                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
	                        </div>
	                    `;
	                } else {
	                    html += renderScriptFileRow(file.name, fullPath);
	                }
	            }

	            html += '</div>';
	            contentEl.innerHTML = html;
	        }

	        function renderScriptsFolderContents(files, basePath) {
	            const visible = (files || []).filter(f => f && !shouldHideScriptsItem(f.name));
	            if (visible.length === 0) {
	                return '<div style="padding: 8px 0 8px 20px; color: #888;">(empty)</div>';
	            }

	            let html = '';
	            for (const file of visible) {
	                const fullPath = `${basePath}/${file.name}`;
	                if (file.is_dir) {
	                    const folderId = `folder-${fullPath.replace(/[^a-zA-Z0-9]/g, '-')}`;
	                    html += `
	                        <div class="artifacts-folder" style="margin-left: 20px;">
	                            <div class="artifacts-folder-header" onclick="toggleScriptsFolder('${escapeHtml(fullPath)}', '${folderId}')" style="cursor: pointer;">
	                                <svg class="folder-chevron" id="chevron-${folderId}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
	                                    <polyline points="9 18 15 12 9 6"></polyline>
	                                </svg>
	                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
	                                </svg>
	                                <span class="artifacts-folder-name">${escapeHtml(file.name)}</span>
	                            </div>
	                            <div class="artifacts-folder-contents" id="${folderId}" style="display: none;"></div>
	                        </div>
	                    `;
	                } else {
	                    html += `<div style="margin-left: 20px;">${renderScriptFileRow(file.name, fullPath)}</div>`;
	                }
	            }
	            return html;
	        }

	        function renderScriptFileRow(name, workspacePath) {
	            const encodedPath = encodeURIComponent(workspacePath || '');
	            const encodedTitle = encodeURIComponent(name || '');
	            const canEdit = isEditableTextFile(workspacePath || name);
	            const editBtn = canEdit ? `
	                        <button class="artifacts-file-btn" onclick="editScriptWorkspaceFile('${encodedPath}', '${encodedTitle}')" title="Edit">
	                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
	                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
	                            </svg>
	                        </button>
	            ` : '';

	            return `
	                <div class="artifacts-file">
	                    <div class="artifacts-file-icon">
	                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
	                            <polyline points="14 2 14 8 20 8"/>
	                        </svg>
	                    </div>
	                    <div class="artifacts-file-info">
	                        <span class="artifacts-file-name">${escapeHtml(name)}</span>
	                        <div class="artifacts-file-url">${escapeHtml(workspacePath)}</div>
	                    </div>
	                    <div class="artifacts-file-actions">
	                        ${editBtn}
	                        <button class="artifacts-file-btn delete" onclick="deleteScriptWorkspaceFile('${encodedPath}')" title="Delete">
	                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                                <polyline points="3 6 5 6 21 6"></polyline>
	                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
	                            </svg>
	                        </button>
	                    </div>
	                </div>
	            `;
	        }

	        async function toggleScriptsFolder(path, folderId) {
	            const contentsEl = document.getElementById(folderId);
	            const chevronEl = document.getElementById(`chevron-${folderId}`);
	            if (!contentsEl || !chevronEl) return;

	            if (contentsEl.style.display === 'none') {
	                contentsEl.style.display = 'block';
	                chevronEl.style.transform = 'rotate(90deg)';

	                if (contentsEl.innerHTML === '') {
	                    contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #888;">Loading...</div>';
	                    const apiKey = document.getElementById('apiKey').value;
	                    try {
	                        const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(path)}`, {
	                            headers: { 'X-API-Key': apiKey }
	                        });
	                        if (response.ok) {
	                            const data = await response.json();
	                            const files = data.files || [];
	                            contentsEl.innerHTML = renderScriptsFolderContents(files, path);
	                        } else {
	                            contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
	                        }
	                    } catch (e) {
	                        contentsEl.innerHTML = '<div style="padding: 8px 0 8px 20px; color: #f66;">Failed to load</div>';
	                    }
	                }
	            } else {
	                contentsEl.style.display = 'none';
	                chevronEl.style.transform = 'rotate(0deg)';
	            }
	        }

	        async function editScriptWorkspaceFile(encodedPath, encodedTitle) {
	            const path = decodeURIComponent(encodedPath || '');
	            const title = decodeURIComponent(encodedTitle || '') || path;
	            if (!isEditableTextFile(path)) {
	                alert('This file type is not editable in the browser.');
	                return;
	            }
	            await openTextEditor(path, title, { containerId: 'scriptsContent', onBack: loadScripts });
	        }

        async function deleteScriptWorkspaceFile(encodedPath) {
            const path = decodeURIComponent(encodedPath || '');
            if (!path) return;
            if (!confirm(`Delete "${path}"?`)) return;
            const ok = await deleteWorkspaceItem(path);
            if (!ok) return;
            await loadScripts();
        }

        async function loadSettingsFiles() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                renderSettingsEmpty('Enter your API key in Settings to view and edit.');
                return;
            }

            const contentEl = document.getElementById('settingsContent');
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

            const [projectFiles, userFiles] = await Promise.all([
                fetchWorkspaceListing('.claude', apiKey),
                fetchWorkspaceListing('.claude-home', apiKey),
            ]);

            const projectIndex = indexWorkspaceFiles(projectFiles);
            const userIndex = indexWorkspaceFiles(userFiles);

            const items = [
                {
                    label: 'Project settings',
                    path: '.claude/settings.json',
                    hint: 'Project scope (merged after user settings).',
                    exists: workspaceFileExists(projectIndex, 'settings.json'),
                },
                {
                    label: 'User settings',
                    path: '.claude-home/settings.json',
                    hint: 'User scope (~/.claude) merged first.',
                    exists: workspaceFileExists(userIndex, 'settings.json'),
                },
                {
                    label: 'Local overrides',
                    path: '.claude/settings.local.json',
                    hint: 'Optional overrides (merged last).',
                    exists: workspaceFileExists(projectIndex, 'settings.local.json'),
                },
            ];

            renderSettingsList(items);
        }

        async function fetchWorkspaceListing(basePath, apiKey) {
            try {
                const response = await fetch(`${API_URL}/workspace?path=${encodeURIComponent(basePath)}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!response.ok) {
                    return null;
                }
                const data = await response.json();
                return data.files || [];
            } catch (e) {
                return null;
            }
        }

        function indexWorkspaceFiles(files) {
            if (!Array.isArray(files)) return null;
            const index = new Map();
            for (const file of files) {
                if (file && typeof file.name === 'string') {
                    index.set(file.name, file);
                }
            }
            return index;
        }

        function workspaceFileExists(index, name) {
            if (!index) return null;
            const entry = index.get(name);
            if (!entry) return false;
            return !entry.is_dir;
        }

        function renderSettingsEmpty(message) {
            const contentEl = document.getElementById('settingsContent');
            contentEl.innerHTML = `
                <div class="artifacts-empty">
                    <div class="artifacts-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <h3>Settings</h3>
                    <p>${escapeHtml(message || 'Settings files are stored on the workspace volume.')}</p>
                </div>
            `;
        }

        function renderSettingsList(items) {
            const contentEl = document.getElementById('settingsContent');
            let html = `
                <div class="skills-pane-header" style="margin-bottom: 12px;">
                    <div>
                        <div class="skills-pane-title">Settings</div>
                        <div class="skills-pane-subtitle">Merged from user → project → local (lists are unioned).</div>
                    </div>
                    <div class="skills-pane-actions">
                        <button class="artifacts-refresh-btn" onclick="promptOpenWorkspaceFile()">Open file path</button>
                    </div>
                </div>
                <div class="artifacts-tree">
            `;

            if (!items || items.length === 0) {
                html += '<div class="artifacts-empty" style="padding: 24px;"><p>(no settings entries)</p></div>';
                html += '</div>';
                contentEl.innerHTML = html;
                return;
            }

            for (const item of items) {
                const exists = item.exists;
                const status = exists === true ? 'present' : exists === false ? 'missing' : 'unknown';
                const editBtn = exists === false ? '' : `
                        <button class="artifacts-file-btn" onclick="editSettingsWorkspaceFile('${encodeURIComponent(item.path)}', '${encodeURIComponent(item.label)}')" title="Edit">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                `;
                const hintLine = item.hint ? `<div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(item.hint)}</div>` : '';

                html += `
                    <div class="artifacts-file">
                        <div class="artifacts-file-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="artifacts-file-info">
                            <span class="artifacts-file-name">${escapeHtml(item.label)}</span>
                            <div class="artifacts-file-url">${escapeHtml(item.path)} • ${escapeHtml(status)}</div>
                            ${hintLine}
                        </div>
                        <div class="artifacts-file-actions">
                            ${editBtn}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            contentEl.innerHTML = html;
        }

        async function editSettingsWorkspaceFile(encodedPath, encodedTitle) {
            const path = decodeURIComponent(encodedPath || '');
            const title = decodeURIComponent(encodedTitle || '') || path;
            if (!path) return;
            await openTextEditor(path, title, { containerId: 'settingsContent', onBack: loadSettingsFiles, allowRename: false });
        }

        function handleTextEditorBack() {
            disposeMonacoEditor();
            if (typeof currentEditorOnBack === 'function') {
                currentEditorOnBack();
	            }
        }

        function isRenameAllowedForPath(path) {
            const normalized = String(path || '').replace(/^\/+/, '');
            if (!normalized) return false;
            if (normalized === '.claude/CLAUDE.md') return false;
            if (normalized.endsWith('/SKILL.md')) return false;
            return true;
        }

        async function openTextEditor(path, title, options = {}) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            disposeMonacoEditor();

            currentEditingFilePath = path;
            currentEditorContainerId = options.containerId || 'commandsContent';
            currentEditorOnBack = options.onBack || loadCommands;
            currentEditorAfterSave = Object.prototype.hasOwnProperty.call(options, 'afterSave') ? options.afterSave : currentEditorOnBack;
            const showBack = options.showBack !== false;
            const allowRename = (options.allowRename !== false) && isRenameAllowedForPath(path);
            const dirName = getPathDirname(path);
            const baseName = getPathBasename(path);
            const dirDisplay = dirName ? `${dirName}/` : '';
            const subtitleHtml = allowRename
                ? `
                    <div class="skills-pane-subtitle" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span id="textEditorDirLabel" style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted);">${escapeHtml(dirDisplay)}</span>
                        <input id="textEditorFilenameInput" class="form-input" value="${escapeHtml(baseName)}" spellcheck="false" autocomplete="off" style="padding: 6px 10px; width: 320px; max-width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                    </div>
                `
                : `<div class="skills-pane-subtitle">${escapeHtml(currentEditingFilePath)}</div>`;
            const renameBtn = allowRename ? `<button class="artifacts-refresh-btn" onclick="renameTextEditorFile()">Rename</button>` : '';

            const contentEl = document.getElementById(currentEditorContainerId);
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading file...</p></div>';

            try {
                const response = await fetch(`${API_URL}/workspace/${encodeURIComponent(path)}`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) {
                    let detail = '';
                    try {
                        const data = await response.json();
                        detail = data.detail || '';
                    } catch (e) {}
                    contentEl.innerHTML = `<div class="artifacts-empty"><h3>Failed to load file</h3>${detail ? `<p>${escapeHtml(detail)}</p>` : ''}</div>`;
                    return;
                }

                const text = await response.text();
                if (text && text.indexOf('\u0000') !== -1) {
                    contentEl.innerHTML = `<div class="artifacts-empty"><h3>Unsupported file type</h3><p>This file doesn't look like plain text.</p></div>`;
                    return;
                }
                const backBtn = showBack ? `<button class="artifacts-refresh-btn" onclick="handleTextEditorBack()">Back</button>` : '';

                contentEl.innerHTML = `
                    <div class="skills-pane">
                        <div class="skills-pane-header">
                            <div>
                                <div class="skills-pane-title" id="textEditorTitle">Editing ${escapeHtml(title)}</div>
                                ${subtitleHtml}
                            </div>
                            <div class="skills-pane-actions">
                                <button class="artifacts-refresh-btn" onclick="saveTextEditor()">Save</button>
                                ${renameBtn}
                                ${backBtn}
                            </div>
                        </div>
                        <div id="monacoEditorArea" class="monaco-editor-host"></div>
                        <div id="textEditorStatus" class="form-hint" style="margin-top: 8px;"></div>
                    </div>
                `;

                const statusEl = document.getElementById('textEditorStatus');
                const hostEl = document.getElementById('monacoEditorArea');
                if (statusEl) statusEl.textContent = 'Loading editor...';

                try {
                    const monaco = await ensureMonacoLoaded();
                    const language = getMonacoLanguageForPath(path);
                    monacoModelInstance = monaco.editor.createModel(text, language);
                    monacoEditorInstance = monaco.editor.create(hostEl, {
                        model: monacoModelInstance,
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontFamily: 'JetBrains Mono, monospace',
                        fontSize: 13,
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                    });
                    monacoEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                        saveTextEditor();
                    });
                    if (statusEl) statusEl.textContent = '';
                } catch (e) {
                    // Fallback to a basic textarea if Monaco fails to load
                    contentEl.innerHTML = `
                        <div class="skills-pane">
                            <div class="skills-pane-header">
                                <div>
                                    <div class="skills-pane-title" id="textEditorTitle">Editing ${escapeHtml(title)}</div>
                                    ${subtitleHtml}
                                </div>
                                <div class="skills-pane-actions">
                                    <button class="artifacts-refresh-btn" onclick="saveTextEditor()">Save</button>
                                    ${renameBtn}
                                    ${backBtn}
                                </div>
                            </div>
                            <textarea id="textEditorArea" class="form-input form-textarea" style="min-height: 320px;"></textarea>
                            <div id="textEditorStatus" class="form-hint" style="margin-top: 8px;"></div>
                        </div>
                    `;
                    const textArea = document.getElementById('textEditorArea');
                    if (textArea) textArea.value = text;
                    const status = document.getElementById('textEditorStatus');
                    if (status) status.textContent = 'Monaco failed to load; using basic editor.';
                }
            } catch (e) {
                contentEl.innerHTML = '<div class="artifacts-empty"><h3>Failed to load file</h3></div>';
            }
        }

        async function renameTextEditorFile() {
            if (!currentEditingFilePath) return false;
            const inputEl = document.getElementById('textEditorFilenameInput');
            if (!inputEl) return true; // nothing to rename

            const desired = String(inputEl.value || '').trim();
            const currentName = getPathBasename(currentEditingFilePath);
            if (!desired || desired === '.' || desired === '..') {
                alert('Please enter a valid filename');
                inputEl.value = currentName;
                return false;
            }
            if (desired.includes('/') || desired.includes('\\')) {
                alert('Filename cannot include path separators');
                inputEl.value = currentName;
                return false;
            }

            if (desired === currentName) return true;

            const dirName = getPathDirname(currentEditingFilePath);
            const newPath = (dirName ? `${dirName}/` : '') + desired;

            const statusEl = document.getElementById('textEditorStatus');
            if (statusEl) statusEl.textContent = 'Renaming...';

            const result = await moveWorkspaceItem(currentEditingFilePath, newPath, false);
            if (!result) {
                if (statusEl) statusEl.textContent = '';
                inputEl.value = currentName;
                return false;
            }

            currentEditingFilePath = newPath;
            const dirLabelEl = document.getElementById('textEditorDirLabel');
            if (dirLabelEl) dirLabelEl.textContent = dirName ? `${dirName}/` : '';
            inputEl.value = desired;

            try {
                if (window.monaco && window.monaco.editor && monacoModelInstance) {
                    window.monaco.editor.setModelLanguage(monacoModelInstance, getMonacoLanguageForPath(newPath));
                }
            } catch (e) {}

            if (statusEl) {
                statusEl.textContent = 'Renamed ✓';
                setTimeout(() => {
                    if (statusEl.textContent === 'Renamed ✓') statusEl.textContent = '';
                }, 1200);
            }

            return true;
        }

        async function saveTextEditor() {
            if (!currentEditingFilePath) return;
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const statusEl = document.getElementById('textEditorStatus');
            const textArea = document.getElementById('textEditorArea');
            const content = monacoEditorInstance ? monacoEditorInstance.getValue() : (textArea ? textArea.value : '');
            if (content === null || content === undefined) return;

            try {
                const renamed = await renameTextEditorFile();
                if (!renamed) return;

                statusEl.textContent = 'Saving...';

                const response = await fetch(`${API_URL}/workspace/${encodeURIComponent(currentEditingFilePath)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    statusEl.textContent = 'Saved ✓';
                    if (typeof currentEditorAfterSave === 'function') {
                        disposeMonacoEditor();
                        currentEditorAfterSave();
                    }
                } else {
                    const data = await response.json();
                    statusEl.textContent = `Save failed: ${data.detail || 'Unknown error'}`;
                }
            } catch (e) {
                statusEl.textContent = `Save failed: ${e.message}`;
            }
        }

        // Legacy functions for backwards compatibility (removed recursive loading)
        function renderArtifacts(tree) {
            renderArtifactsEmpty();
        }

        function flattenArtifactsTree(tree) {
            return [];
        }

        function renderArtifactsTree(tree, depth = 0) {
            let html = '';

            for (const item of tree) {
                if (item.is_dir) {
                    const fileCount = 0;
                    html += `
                        <div class="artifacts-folder">
                            <div class="artifacts-folder-header">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="artifacts-folder-name">${escapeHtml(item.name)}</span>
                                <span class="artifacts-folder-count">${fileCount} file${fileCount !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="artifacts-folder-contents">
                                ${renderArtifactsTree(item.children || [], depth + 1)}
                            </div>
                        </div>
                    `;
                } else {
                    // Remove "artifacts/" prefix from path for the public URL
                    const publicPath = item.path.replace(/^artifacts\//, '');
                    const publicUrl = `${API_URL}/artifacts/${publicPath}`;

                    html += `
                        <div class="artifacts-file">
                            <div class="artifacts-file-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                            <div class="artifacts-file-info">
                                <a href="${escapeHtml(publicUrl)}" target="_blank" rel="noopener" class="artifacts-file-name">${escapeHtml(item.name)}</a>
                                <div class="artifacts-file-url">${escapeHtml(publicUrl)}</div>
                            </div>
                            <div class="artifacts-file-actions">
                                <button class="artifacts-file-btn" onclick="copyToClipboard('${escapeHtml(publicUrl)}')" title="Copy URL">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                <button class="artifacts-file-btn" onclick="window.open('${escapeHtml(publicUrl)}', '_blank')" title="Open in new tab">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            return html;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show a toast notification here
            }).catch(() => {});
        }

        // Tab switching and sessions
        let currentExplorerTab = 'artifacts';
        let currentViewingSession = null;

	        function switchExplorerTab(tab) {
	            currentExplorerTab = tab;
	            currentViewingSession = null;

	            // Update tab buttons
	            document.getElementById('tabClaudeMd').classList.toggle('active', tab === 'claude');
	            document.getElementById('tabSkills').classList.toggle('active', tab === 'skills');
            document.getElementById('tabArtifacts').classList.toggle('active', tab === 'artifacts');
            document.getElementById('tabCommands').classList.toggle('active', tab === 'commands');
            document.getElementById('tabPrompts').classList.toggle('active', tab === 'prompts');
            document.getElementById('tabScripts').classList.toggle('active', tab === 'scripts');
            document.getElementById('tabSettings').classList.toggle('active', tab === 'settings');
            document.getElementById('tabSessions').classList.toggle('active', tab === 'sessions');

	            // Show/hide content
	            document.getElementById('claudeContent').style.display = tab === 'claude' ? 'block' : 'none';
	            document.getElementById('skillsContent').style.display = tab === 'skills' ? 'block' : 'none';
	            document.getElementById('artifactsContent').style.display = tab === 'artifacts' ? 'block' : 'none';
            document.getElementById('commandsContent').style.display = tab === 'commands' ? 'block' : 'none';
            document.getElementById('promptsContent').style.display = tab === 'prompts' ? 'block' : 'none';
            document.getElementById('scriptsContent').style.display = tab === 'scripts' ? 'block' : 'none';
            document.getElementById('settingsContent').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('sessionsContent').style.display = tab === 'sessions' ? 'block' : 'none';

	            // Load content
	            if (tab === 'claude') {
	                loadClaudeMd();
	            } else if (tab === 'skills') {
	                if (currentSkillExplorer && currentSkillExplorer.id) {
	                    loadSkillExplorer();
	                } else {
	                    loadSkills();
	                }
	            } else if (tab === 'artifacts') {
	                loadArtifacts();
	            } else if (tab === 'commands') {
	                loadCommands();
	            } else if (tab === 'prompts') {
	                loadPromptFiles();
            } else if (tab === 'scripts') {
                loadScripts();
            } else if (tab === 'settings') {
                loadSettingsFiles();
            } else {
                loadSessions();
            }
        }

	        function refreshCurrentTab() {
	            if (currentExplorerTab === 'claude') {
	                loadClaudeMd();
	            } else if (currentExplorerTab === 'skills') {
	                if (currentSkillExplorer && currentSkillExplorer.id) {
	                    loadSkillExplorer();
	                } else {
	                    loadSkills();
	                }
	            } else if (currentExplorerTab === 'artifacts') {
	                loadArtifacts();
	            } else if (currentExplorerTab === 'commands') {
	                loadCommands();
	            } else if (currentExplorerTab === 'prompts') {
	                loadPromptFiles();
            } else if (currentExplorerTab === 'scripts') {
                loadScripts();
            } else if (currentExplorerTab === 'settings') {
                loadSettingsFiles();
            } else {
                if (currentViewingSession) {
                    loadSessionDetail(currentViewingSession);
	                } else {
	                    loadSessions();
                }
            }
        }

        async function loadClaudeMd() {
            const apiKey = document.getElementById('apiKey').value;
            const contentEl = document.getElementById('claudeContent');
            if (!apiKey) {
                contentEl.innerHTML = `
                    <div class="artifacts-empty">
                        <h3>CLAUDE.md</h3>
                        <p>Enter your API key in Settings to view and edit.</p>
                    </div>
                `;
                return;
            }

            await openTextEditor('.claude/CLAUDE.md', 'CLAUDE.md', {
                containerId: 'claudeContent',
                showBack: false,
                afterSave: null,
                allowRename: false,
            });
        }

        async function loadSessions() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                renderSessions([]);
                return;
            }

            const contentEl = document.getElementById('sessionsContent');
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading...</p></div>';

            try {
                const response = await fetch(`${API_URL}/sessions`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderSessions(data.sessions || []);
                } else {
                    renderSessions([]);
                }
            } catch (e) {
                console.error('Failed to load sessions:', e);
                renderSessions([]);
            }
        }

        function renderSessions(sessions) {
            const contentEl = document.getElementById('sessionsContent');

            if (sessions.length === 0) {
                contentEl.innerHTML = `
                    <div class="artifacts-empty">
                        <div class="artifacts-empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <h3>No sessions yet</h3>
                        <p>Claude session logs will appear here.</p>
                    </div>
                `;
                return;
            }

            contentEl.innerHTML = `
                <div class="sessions-list">
                    ${sessions.map(session => `
                        <div class="session-item" onclick="loadSessionDetail('${escapeHtml(session.id)}')">
                            <div class="session-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                            <div class="session-info">
                                <div class="session-id">${escapeHtml(session.id)}</div>
                                <div class="session-meta">
                                    <span>${formatFileSize(session.size)}</span>
                                    <span>${formatRelativeTime(session.modified * 1000)}</span>
                                </div>
                            </div>
                            <div class="session-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadSessionDetail(sessionId) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) return;

            currentViewingSession = sessionId;
            const contentEl = document.getElementById('sessionsContent');
            contentEl.innerHTML = '<div class="artifacts-empty"><p>Loading session...</p></div>';

            try {
                const response = await fetch(`${API_URL}/sessions/${encodeURIComponent(sessionId)}`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    const session = await response.json();
                    renderSessionDetail(session);
                } else {
                    contentEl.innerHTML = '<div class="artifacts-empty"><h3>Failed to load session</h3></div>';
                }
            } catch (e) {
                console.error('Failed to load session:', e);
                contentEl.innerHTML = '<div class="artifacts-empty"><h3>Failed to load session</h3></div>';
            }
        }

        function formatSessionBlockContent(content) {
            if (Array.isArray(content)) {
                const textBlocks = content.filter(c => c && c.type === 'text' && typeof c.text === 'string');
                const otherBlocks = content.filter(c => !c || c.type !== 'text');
                const parts = [];
                if (textBlocks.length) {
                    parts.push(textBlocks.map(c => c.text).join('\n'));
                }
                if (otherBlocks.length) {
                    parts.push(otherBlocks.map(formatSessionBlock).join('\n\n'));
                }
                return parts.join('\n\n');
            }

            if (content && typeof content === 'object') {
                return JSON.stringify(content, null, 2);
            }

            return content == null ? '' : String(content);
        }

        function formatSessionBlock(block) {
            if (!block || typeof block !== 'object') {
                return String(block);
            }

            const type = block.type || 'unknown';
            if (type === 'tool_use') {
                const name = block.name || 'unknown';
                const id = block.id ? ` (${block.id})` : '';
                const input = block.input === undefined ? '' : JSON.stringify(block.input, null, 2);
                return `[tool_use] ${name}${id}${input ? `\n${input}` : ''}`;
            }

            if (type === 'tool_result') {
                const id = block.tool_use_id ? ` (${block.tool_use_id})` : '';
                const status = block.is_error ? ' error' : '';
                const content = formatSessionBlockContent(block.content);
                return `[tool_result${status}]${id}${content ? `\n${content}` : ''}`;
            }

            if (type === 'image') {
                const mediaType = block.source?.media_type || 'image';
                const dataLength = block.source?.data ? block.source.data.length : 0;
                const sizeLabel = dataLength ? ` (${dataLength} bytes base64)` : '';
                return `[image] ${mediaType}${sizeLabel}`;
            }

            if (type === 'text') {
                return block.text || '';
            }

            return JSON.stringify(block, null, 2);
        }

        function buildSessionEntryDisplay(entry) {
            let displayType = entry.type || 'unknown';
            let displayRole = entry.message?.role || '';
            let textContent = '';
            let toolUseBlocks = [];
            let toolResultBlocks = [];
            let otherBlocks = [];

            const msgContent = entry.message?.content;
            if (typeof msgContent === 'string') {
                textContent = msgContent;
            } else if (Array.isArray(msgContent)) {
                for (const block of msgContent) {
                    if (block && block.type === 'text') {
                        if (block.text) {
                            textContent = textContent ? `${textContent}\n${block.text}` : block.text;
                        }
                    } else if (block && block.type === 'tool_use') {
                        toolUseBlocks.push(block);
                    } else if (block && block.type === 'tool_result') {
                        toolResultBlocks.push(block);
                    } else if (block) {
                        otherBlocks.push(block);
                    }
                }
            } else if (msgContent != null) {
                textContent = JSON.stringify(msgContent, null, 2);
            }

            const trimmedText = (textContent || '').trim();
            const isPlaceholderText = trimmedText === '' || trimmedText === '(no content)';
            const formattedBlocks = [
                ...toolUseBlocks.map(formatSessionBlock),
                ...toolResultBlocks.map(formatSessionBlock),
                ...otherBlocks.map(formatSessionBlock),
            ].filter(Boolean);

            let content = '';
            if (formattedBlocks.length) {
                content = isPlaceholderText
                    ? formattedBlocks.join('\n\n')
                    : [textContent, formattedBlocks.join('\n\n')].filter(Boolean).join('\n\n');
            } else {
                content = textContent;
            }

            if (isPlaceholderText && !formattedBlocks.length) {
                if (entry.result) {
                    content = JSON.stringify(entry.result, null, 2);
                } else {
                    content = JSON.stringify(entry, null, 2);
                }
            } else if (!content) {
                if (entry.result) {
                    content = JSON.stringify(entry.result, null, 2);
                } else {
                    content = JSON.stringify(entry, null, 2);
                }
            }

            if (isPlaceholderText && toolResultBlocks.length) {
                displayType = 'tool-result';
                displayRole = 'tool';
            } else if (isPlaceholderText && toolUseBlocks.length) {
                displayType = 'tool-use';
                displayRole = 'tool';
            }

            return { displayType, displayRole, content };
        }

        function sanitizeSessionTypeClass(type) {
            return (type || 'unknown').toLowerCase().replace(/[^a-z0-9_-]/g, '-');
        }

        function renderSessionDetail(session) {
            const contentEl = document.getElementById('sessionsContent');

            const entriesHtml = session.entries.map((entry, idx) => {
                const { displayType, displayRole, content } = buildSessionEntryDisplay(entry);
                const typeClass = sanitizeSessionTypeClass(displayType);
                const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '';

                // Truncate very long content for display
                const displayContent = content.length > 5000
                    ? content.substring(0, 5000) + '\n\n... (truncated)'
                    : content;

                return `
                    <div class="session-entry">
                        <div class="session-entry-header" onclick="toggleEntryContent(${idx})">
                            <span class="session-entry-type ${typeClass}">${escapeHtml(displayType)}</span>
                            <span>${escapeHtml(displayRole)}</span>
                            <span class="session-entry-timestamp">${timestamp}</span>
                        </div>
                        <div class="session-entry-content" id="entry-content-${idx}">
                            <pre class="session-entry-json">${escapeHtml(displayContent)}</pre>
                        </div>
                    </div>
                `;
            }).join('');

            contentEl.innerHTML = `
                <div class="session-viewer-header">
                    <button class="session-back-btn" onclick="backToSessionsList()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <span class="session-viewer-title">${escapeHtml(session.id)}.jsonl</span>
                    <span class="session-viewer-meta">${session.entry_count} entries · ${formatFileSize(session.size)}</span>
                </div>
                <div class="session-entries">
                    ${entriesHtml}
                </div>
            `;
        }

        function toggleEntryContent(idx) {
            const el = document.getElementById(`entry-content-${idx}`);
            if (el) {
                el.classList.toggle('collapsed');
            }
        }

        function backToSessionsList() {
            currentViewingSession = null;
            loadSessions();
        }

        function formatRelativeTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';

            return new Date(timestamp).toLocaleDateString();
        }

        async function loadSkillForEdit(skillId) {
            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await fetch(`${API_URL}/skills/${skillId}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (response.ok) {
                    const skill = await response.json();
                    document.getElementById('skillId').value = skill.id;
                    document.getElementById('skillId').disabled = true;
                    document.getElementById('skillContent').value = skill.content;
                }
            } catch (error) {
                alert('Failed to load skill: ' + error.message);
            }
        }

        async function editSkill(skillId) {
            const path = `.claude/skills/${skillId}/SKILL.md`;
            await openTextEditor(path, `SKILL.md (${skillId})`, { containerId: 'skillsContent', onBack: loadSkills, allowRename: false });
        }

        async function saveSkill() {
            const apiKey = document.getElementById('apiKey').value;
            
            // If there's a pending zip file, upload it
            if (pendingSkillZip) {
                await uploadSkillZip(pendingSkillZip);
                closeSkillModal();
                return;
            }
            
            // Otherwise, do manual save
            const skillId = document.getElementById('skillId').value.trim();
            const content = document.getElementById('skillContent').value;

            if (!skillId) {
                alert('Please enter a skill ID');
                return;
            }

            if (!content) {
                alert('Please enter skill content');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/skills`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ id: skillId, content })
                });

                if (response.ok) {
                    closeSkillModal();
                    loadSkills();
                } else {
                    const data = await response.json();
                    alert('Failed to save skill: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save skill: ' + error.message);
            }
        }

        async function deleteSkill(skillId) {
            if (!confirm(`Delete skill "${skillId}"?`)) return;

            const apiKey = document.getElementById('apiKey').value;
            try {
                const response = await fetch(`${API_URL}/skills/${skillId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });

                if (response.ok) {
                    currentSkillExplorer = null;
                    loadSkills();
                } else {
                    const data = await response.json();
                    alert('Failed to delete skill: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete skill: ' + error.message);
            }
        }

        async function checkConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const statusEl = document.getElementById('apiStatus');
            const statusText = document.getElementById('statusText');

            if (!API_URL) {
                statusEl.className = 'api-status disconnected';
                statusText.textContent = 'API URL not set';
                renderSkills([]);
                resetPromptCache();
                return;
            }

            if (!apiKey) {
                statusEl.className = 'api-status disconnected';
                statusText.textContent = 'Not connected';
                renderSkills([]);
                resetPromptCache();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    statusEl.className = 'api-status connected';
                    statusText.textContent = 'Connected';
                    loadSkills();
                    loadModelsFromApi();
                    loadPromptsFromApi();
                } else {
                    statusEl.className = 'api-status disconnected';
                    statusText.textContent = 'Connection failed';
                    renderSkills([]);
                    resetPromptCache();
                }
            } catch {
                statusEl.className = 'api-status disconnected';
                statusText.textContent = 'Connection failed';
                renderSkills([]);
                resetPromptCache();
            }
            updateSendButton();
        }

        // Chat management
        function loadChats() {
            const chats = JSON.parse(localStorage.getItem('clawed_chats') || '[]');
            renderChatsList(chats);
        }

        function saveChats(chats) {
            localStorage.setItem('clawed_chats', JSON.stringify(chats));
            renderChatsList(chats);
        }

        function renderChatsList(chats) {
            const container = document.getElementById('chatsList');
            
            if (chats.length === 0) {
                container.innerHTML = '<div class="no-chats">No conversations yet</div>';
                return;
            }

            container.innerHTML = chats.map(chat => `
                <div class="chat-item ${chat.id === currentSessionId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    <div class="chat-item-title">${escapeHtml(chat.title)}</div>
                    <div class="chat-item-date">${formatDate(chat.updatedAt)}</div>
                    <div class="chat-item-actions">
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function newChat() {
            currentSessionId = 'chat-' + Date.now();
            document.getElementById('messages').innerHTML = '';
            document.getElementById('welcome').style.display = 'flex';
            document.getElementById('messageInput').focus();
            loadChats();
        }

        function loadChat(chatId) {
            const chats = JSON.parse(localStorage.getItem('clawed_chats') || '[]');
            const chat = chats.find(c => c.id === chatId);
            
            if (!chat) return;

            currentSessionId = chatId;
            document.getElementById('welcome').style.display = 'none';
            
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = chat.messages.map(msg => renderMessage(msg)).join('');
            
            scrollToBottom();
            loadChats();
        }

        function deleteChat(chatId) {
            let chats = JSON.parse(localStorage.getItem('clawed_chats') || '[]');
            chats = chats.filter(c => c.id !== chatId);
            saveChats(chats);

            if (chatId === currentSessionId) {
                newChat();
            }
        }

        function updateChatInStorage(sessionId, userMessage, assistantResponse) {
            let chats = JSON.parse(localStorage.getItem('clawed_chats') || '[]');
            let chat = chats.find(c => c.id === sessionId);

            if (!chat) {
                chat = {
                    id: sessionId,
                    title: userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : ''),
                    messages: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                chats.unshift(chat);
            }

            chat.messages.push({ role: 'user', content: userMessage });
            chat.messages.push({ 
                role: 'assistant', 
                content: assistantResponse.response,
                tools: assistantResponse.tools_used,
                model: assistantResponse.model
            });
            chat.updatedAt = Date.now();

            // Keep only last 50 chats
            chats = chats.slice(0, 50);
            saveChats(chats);
        }

        // File handling
        function handleFileSelect(event) {
            handleFiles(event.target.files);
        }

        function isTextFile(filename) {
            const textExtensions = [
                '.md', '.txt', '.json', '.js', '.ts', '.jsx', '.tsx', '.py', '.sh',
                '.html', '.css', '.xml', '.yaml', '.yml', '.toml', '.ini', '.cfg',
                '.csv', '.sql', '.rb', '.go', '.rs', '.java', '.c', '.cpp', '.h',
                '.swift', '.kt', '.php', '.pl', '.r', '.lua', '.vim', '.conf',
                '.env', '.gitignore', '.dockerfile', '.log'
            ];
            const lower = filename.toLowerCase();
            return textExtensions.some(ext => lower.endsWith(ext));
        }

        function handleFiles(fileList) {
            for (const file of fileList) {
                if (attachedFiles.length >= 5) {
                    alert('Maximum 5 files allowed');
                    break;
                }

                const reader = new FileReader();
                const isText = isTextFile(file.name);

                reader.onload = (e) => {
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        content: e.target.result,
                        isText: isText
                    });
                    renderAttachedFiles();
                    updateSendButton();
                };

                // Read text files as text, images as dataURL
                if (isText) {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            }
        }

        function renderAttachedFiles() {
            const container = document.getElementById('attachedFiles');
            
            if (attachedFiles.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = attachedFiles.map((file, index) => `
                <div class="attached-file">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <span class="attached-file-name">${escapeHtml(file.name)}</span>
                    <button class="remove-file" onclick="removeFile(${index})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            renderAttachedFiles();
            updateSendButton();
        }

        async function interruptSession(sessionId) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey || !API_URL || !sessionId) return;
            try {
                await fetch(`${API_URL}/chat/interrupt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
            } catch (error) {
                console.warn('Failed to interrupt session:', error);
            }
        }

        async function stopStreaming() {
            if (!isLoading || isStopping) return;
            isStopping = true;
            updateSendButton();
            if (currentStreamController) {
                currentStreamController.abort();
            }
            if (currentStreamReader) {
                try {
                    await currentStreamReader.cancel();
                } catch (error) {
                    console.warn('Failed to cancel stream reader:', error);
                }
            }
            if (currentStreamSessionId) {
                interruptSession(currentStreamSessionId);
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const apiKey = document.getElementById('apiKey').value;
            let message = input.value.trim();

            if ((!message && attachedFiles.length === 0) || !apiKey || isLoading) return;

            // Separate images from other files
            const imageFiles = attachedFiles.filter(f => f.type.startsWith('image/'));
            const textFiles = attachedFiles.filter(f => f.isText);
            const otherFiles = attachedFiles.filter(f => !f.type.startsWith('image/') && !f.isText);

            // Append text file contents to message
            if (textFiles.length > 0) {
                const fileContents = textFiles.map(f => {
                    return `--- ${f.name} ---\n${f.content}\n--- end ${f.name} ---`;
                }).join('\n\n');
                message = message ? `${message}\n\n${fileContents}` : fileContents;
            }

            // Append non-text, non-image file info to message (binary files)
            if (otherFiles.length > 0) {
                const fileDescriptions = otherFiles.map(f => `[Attached binary file: ${f.name} - cannot display contents]`).join('\n');
                message = message ? `${message}\n\n${fileDescriptions}` : fileDescriptions;
            }

            // If only images and no message, add a default prompt
            if (!message && imageFiles.length > 0) {
                message = "Please analyze this image.";
            }

            if (!currentSessionId) {
                currentSessionId = 'chat-' + Date.now();
            }
            currentStreamSessionId = currentSessionId;
            isStopping = false;
            currentStreamController = new AbortController();
            currentStreamReader = null;

            // Clear input and files
            input.value = '';
            const sentFiles = [...attachedFiles];
            attachedFiles = [];
            renderAttachedFiles();
            autoResizeTextarea();
            updateSendButton();

            // Hide welcome
            document.getElementById('welcome').style.display = 'none';

            // Add user message
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML += renderMessage({ role: 'user', content: message, files: sentFiles });

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            messagesEl.innerHTML += `
                <div class="message assistant" id="${loadingId}">
                    <div class="message-header">
                        <div class="message-avatar">C</div>
                        <div class="message-role">Cloude Agent</div>
                    </div>
                    <div class="loading">
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Thinking...</span>
                    </div>
                </div>
            `;
            scrollToBottom();

            isLoading = true;
            updateSendButton();

            const selectedModel = getSelectedModel();
            let assistantMsgId = null;
            let contentEl = null;
            let toolsEl = null;
            let fullResponse = '';
            let toolsUsed = [];
            let didPersistChat = false;
            const persistChatOnce = (responseText, toolList = toolsUsed) => {
                if (didPersistChat || !currentSessionId) return;
                didPersistChat = true;
                updateChatInStorage(currentSessionId, message, { 
                    response: responseText, 
                    tools_used: toolList,
                    model: selectedModel 
                });
            };

            // Prepare images array for API
            const images = imageFiles.map(f => {
                // Extract base64 data from dataURL (remove "data:image/jpeg;base64," prefix)
                const base64Data = f.content.split(',')[1];
                return {
                    data: base64Data,
                    media_type: f.type || 'image/jpeg'
                };
            });

            try {
                // Get permission mode
                const bypassPermissions = document.getElementById('bypassPermissions').checked;
                const permissionMode = bypassPermissions ? 'bypassPermissions' : 'acceptEdits';

                const requestBody = {
                    session_id: currentSessionId,
                    message: message,
                    context: {
                        source: 'web-chat',
                        user_name: 'User',
                        permission_mode: permissionMode
                    }
                };

                if (selectedModel) {
                    requestBody.model = selectedModel;
                }
                const selectedPrompt = getSelectedPrompt();
                if (selectedPrompt) {
                    requestBody.context.prompt_id = selectedPrompt;
                }

                // Only include images if there are any
                if (images.length > 0) {
                    requestBody.images = images;
                }

                // Use streaming endpoint
                const response = await fetch(`${API_URL}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(requestBody),
                    signal: currentStreamController.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Request failed');
                }

                // Remove loading indicator and add empty assistant message
                document.getElementById(loadingId)?.remove();
                assistantMsgId = 'assistant-' + Date.now();
                messageMarkdown[assistantMsgId] = '';
                const modelBadgeLabel = getModelBadgeLabel(selectedModel);
                messagesEl.innerHTML += `
                    <div class="message assistant" id="${assistantMsgId}" data-markdown="">
                        <div class="message-header">
                            <div class="message-avatar">C</div>
                            <div class="message-role">Cloude Agent${modelBadgeLabel ? `<span class="model-badge">${escapeHtml(modelBadgeLabel)}</span>` : ''}</div>
                            <div class="message-actions">
                                <button class="copy-btn" id="${assistantMsgId}-copy" onclick="copyMessageMarkdown('${assistantMsgId}')">Copy</button>
                            </div>
                        </div>
                        <div class="message-content" id="${assistantMsgId}-content"></div>
                        <div class="tools-used" id="${assistantMsgId}-tools" style="display:none;"></div>
                    </div>
                `;
                
                contentEl = document.getElementById(`${assistantMsgId}-content`);
                toolsEl = document.getElementById(`${assistantMsgId}-tools`);
                fullResponse = '';
                toolsUsed = [];
                let currentStatus = '';
                let pendingPlaceholder = '';
                let sawToolActivity = false;

                // Status messages for UI
                const statusMessages = {
                    'connecting': '🔌 Connecting...',
                    'sending': '📤 Sending request...',
                    'processing': '🧠 Processing...',
                    'ready': '✨ Claude is thinking...'
                };

                // Show initial status
                contentEl.innerHTML = '<div class="status-indicator">🔌 Connecting...</div>';

                // Read SSE stream
                const reader = response.body.getReader();
                currentStreamReader = reader;
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.slice(6));
                                
                                if (event.type === 'status') {
                                    currentStatus = event.status;
                                    const statusText = statusMessages[event.status] || event.status;
                                    if (!fullResponse) {
                                        contentEl.innerHTML = `<div class="status-indicator">${statusText}</div>`;
                                    }
                                } else if (event.type === 'text') {
                                    const incomingText = event.text || '';
                                    const trimmedText = incomingText.trim();
                                    if (trimmedText === '(no content)' && !fullResponse.trim()) {
                                        pendingPlaceholder = incomingText;
                                    } else {
                                        if (pendingPlaceholder) {
                                            pendingPlaceholder = '';
                                        }
                                        fullResponse += incomingText;
                                        contentEl.innerHTML = formatContent(fullResponse);
                                        messageMarkdown[assistantMsgId] = fullResponse;
                                        const msgEl = document.getElementById(assistantMsgId);
                                        if (msgEl) {
                                            msgEl.dataset.markdown = encodeURIComponent(fullResponse);
                                        }
                                        scrollToBottom();
                                    }
                                } else if (event.type === 'tool') {
                                    sawToolActivity = true;
                                    // Show tool with status
                                    const toolStatus = event.status === 'started' ? '⏳' : '✅';
                                    if (event.status === 'started') {
                                        toolsUsed.push(event.name);
                                        // Show working indicator if no text yet
                                        if (!fullResponse) {
                                            contentEl.innerHTML = `<div class="status-indicator">🔧 Using ${event.name}...</div>`;
                                        }
                                    }
                                    toolsEl.style.display = 'block';
                                    toolsEl.innerHTML = toolsUsed.map((t, i) => {
                                        const isLast = i === toolsUsed.length - 1;
                                        const icon = isLast && event.status === 'started' ? '⏳' : '✅';
                                        return `<span class="tool-badge">${icon} ${escapeHtml(t)}</span>`;
                                    }).join('');
                                    scrollToBottom();
                                } else if (event.type === 'done') {
                                    if (!fullResponse.trim()) {
                                        if (pendingPlaceholder && !sawToolActivity) {
                                            fullResponse = pendingPlaceholder;
                                            contentEl.innerHTML = formatContent(fullResponse);
                                            messageMarkdown[assistantMsgId] = fullResponse;
                                            const msgEl = document.getElementById(assistantMsgId);
                                            if (msgEl) {
                                                msgEl.dataset.markdown = encodeURIComponent(fullResponse);
                                            }
                                        } else if (sawToolActivity) {
                                            contentEl.innerHTML = '<div class="status-indicator">✅ Tool run completed.</div>';
                                        }
                                    }
                                    persistChatOnce(fullResponse, toolsUsed);
                                    // Refresh explorer tab if it's open (files may have changed)
                                    if (document.getElementById('artifactsModal').classList.contains('active')) {
                                        refreshCurrentTab();
                                    }
                                } else if (event.type === 'error') {
                                    const errorText = fullResponse.trim()
                                        ? `${fullResponse}\n\nError: ${event.error || 'Unknown error'}`
                                        : `Error: ${event.error || 'Unknown error'}`;
                                    contentEl.innerHTML = formatContent(errorText);
                                    persistChatOnce(errorText, toolsUsed);
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE event:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                const isAbort = isStopping || error.name === 'AbortError';
                if (isAbort) {
                    if (assistantMsgId) {
                        if (!fullResponse.trim() && contentEl) {
                            contentEl.innerHTML = '<div class="status-indicator">Stopped.</div>';
                        }
                        if (currentSessionId) {
                            const storedResponse = fullResponse.trim() ? fullResponse : 'Stopped.';
                            messageMarkdown[assistantMsgId] = storedResponse;
                            const msgEl = document.getElementById(assistantMsgId);
                            if (msgEl) {
                                msgEl.dataset.markdown = encodeURIComponent(storedResponse);
                            }
                            persistChatOnce(storedResponse, toolsUsed);
                        }
                    } else {
                        messagesEl.innerHTML += renderMessage({ 
                            role: 'assistant', 
                            content: 'Stopped.'
                        });
                        if (currentSessionId) {
                            persistChatOnce('Stopped.', []);
                        }
                    }
                } else {
                    messagesEl.innerHTML += renderMessage({ 
                        role: 'assistant', 
                        content: `Error: ${error.message}`,
                        isError: true
                    });
                    const errorText = fullResponse.trim()
                        ? `${fullResponse}\n\nError: ${error.message}`
                        : `Error: ${error.message}`;
                    persistChatOnce(errorText, toolsUsed);
                }
            }

            isLoading = false;
            isStopping = false;
            currentStreamController = null;
            currentStreamReader = null;
            currentStreamSessionId = null;
            updateSendButton();
            scrollToBottom();
        }

        function renderMessage(msg) {
            const isUser = msg.role === 'user';
            const messageId = msg.id || ('msg-' + Date.now() + '-' + Math.random().toString(36).slice(2));
            const avatar = isUser ? 'U' : 'C';
            const role = isUser ? 'You' : 'Cloude Agent';
            const markdown = msg.content || '';
            const content = formatContent(markdown);
            const encodedMarkdown = encodeURIComponent(markdown);

            let modelHtml = '';
            if (!isUser) {
                const label = getModelBadgeLabel(msg.model || '');
                if (label) {
                    modelHtml = `<span class="model-badge">${escapeHtml(label)}</span>`;
                }
            }

            let filesHtml = '';
            if (msg.files && msg.files.length > 0) {
                filesHtml = `
                    <div class="message-files">
                        ${msg.files.map(f => `
                            <div class="file-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                ${escapeHtml(f.name)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            let toolsHtml = '';
            if (msg.tools && msg.tools.length > 0) {
                toolsHtml = `
                    <div class="tools-used">
                        ${msg.tools.map(t => `<span class="tool-badge">🔧 ${escapeHtml(t)}</span>`).join('')}
                    </div>
                `;
            }

            return `
                <div class="message ${msg.role}${msg.isError ? ' error' : ''}" id="${messageId}" data-markdown="${encodedMarkdown}">
                    <div class="message-header">
                        <div class="message-avatar">${avatar}</div>
                        <div class="message-role">${role}${modelHtml}</div>
                        ${!isUser ? `<div class="message-actions"><button class="copy-btn" id="${messageId}-copy" onclick="copyMessageMarkdown('${messageId}')">Copy</button></div>` : ''}
                    </div>
                    <div class="message-content">${content}</div>
                    ${filesHtml}
                    ${toolsHtml}
                </div>
            `;
        }

        function formatContent(text) {
            if (window.marked && typeof marked.parse === 'function') {
                marked.setOptions({ breaks: true });
                const html = marked.parse(text || '');
                // Sanitize to prevent XSS attacks
                if (window.DOMPurify) {
                    return DOMPurify.sanitize(html);
                }
                return html;
            }

            // Fallback minimal formatting
            let html = escapeHtml(text || '');
            html = html.replace(/\n/g, '<br>');
            return `<p>${html}</p>`;
        }

        function copyMessageMarkdown(messageId) {
            const btn = document.getElementById(`${messageId}-copy`);
            const container = document.getElementById(messageId);

            let markdown = messageMarkdown[messageId] || '';
            if (!markdown && container && container.dataset && container.dataset.markdown) {
                markdown = decodeURIComponent(container.dataset.markdown);
            }

            if (!markdown) return;

            navigator.clipboard.writeText(markdown).then(() => {
                if (btn) {
                    const original = btn.textContent;
                    btn.textContent = 'Copied';
                    setTimeout(() => { btn.textContent = original; }, 1200);
                }
            }).catch(() => {});
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            
            return date.toLocaleDateString();
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Initialize with a new chat session
        newChat();
    </script>
</body>
</html>
